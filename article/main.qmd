---
title: "AS CENTRALIDADES FINANCEIRAS NO ESPAÇO URBANO: UMA ANÁLISE ESPACIAL EMPÍRICA E EXPLORATÓRIA DO SETOR BANCÁRIO NO MUNICÍPIO DE SÃO PAULO, NO ANO DE 2010."
author: "Flávio Hugo Pangracio Silva"
registration_number: 99079
advisor: "Igor Santos Tupy"
institution: "UNIVERSIDADE FEDERAL DE VIÇOSA"
city: "VIÇOSA"
state: "MG"
year: "2023"
bibliography: referencies/ref.bib
csl: cite_styles/abnt.csl
number-sections: true
lang: pt-BR
linkcolor: "black"
highlight-style: kate
fig-cap-location: top
format:
    pdf:
        template-partials:
            - tex_files/before-body.tex
            - tex_files/doc-class.tex
---

\pagestyle{fancy} <!-- Show the page number --> \justify

# INTRODUÇÃO

Na literatura sobre economia regional, há poucos trabalhos analisando a moeda e o seu papel para o desenvolvimento regional. Modelos como o neoclássico, o de causação cumulativa e o de insumo-produto, não consideram o impacto da moeda e de variáveis financeiras. Segundo Crocco *et al*., [-@crocco2006], essas variáveis são tratadas em modelos econométricos como exógenas, de forma que afetam a determinação regional de renda em razão das características específicas de cada região. Logo, a moeda e os fluxos monetários têm sido explicados como o resultado da diferença entre as regiões e não como os causadores dessa diferença. Amado [-@amado2006] também destaca que variáveis monetárias e financeiras são recorrentemente negligenciadas em estudos sobre a questão regional.

Além disso, há uma lacuna na literatura quanto ao papel da moeda no desenvolvimento urbano, sobretudo quanto aos fatores distributivos e qualitativos na oferta de crédito dentro das cidades. Trabalhos como o de Hashimoto, Pažitka e Wójcik [-@hashimoto2022], Hashimoto e Wójcik [-@hashimoto2021], Tupy [-@tupy2016], Crocco [-@crocco2012] e Parr e Budd [-@parr] focaram na questão locacional e hierárquica dos serviços financeiros, utilizando-se de dados de emprego no setor financeiro e número de agências para determinar coeficientes de localização e centralidade dessas atividades. Outros trabalhos, como os de Memarian *et al*., [-@memarian2023] e Chauvet e Jacolin [-@chauvet2017] exploraram o impacto da concentração bancária no acesso ao crédito por parte das firmas, ao utilizarem dados do endividamento das firmas e obstáculos geográficos até a agência bancária. Todas essas contribuições tangenciam de alguma forma o papel da moeda no desenvolvimento urbano, mas não discutem concentração de crédito e desigualdade financeira dentro das cidades.

Por conta disso, faz-se necessário um trabalho que dê palco central para a distribuição do crédito no espaço urbano, revisite as contribuições passadas sobre a questão regional do crédito e do setor bancário e utilize do grande volume de dados disponíveis nos dias atuais para testar hipóteses, realizar análises espaciais e dar condições para formulação de políticas públicas de acesso à crédito no âmbito urbano.

Nesse sentido, ainda há muitas questões a se explorar e responder sobre o tema da moeda no espaço: As concentrações bancárias já identificadas por Selmier [-@selmier2016], Tupy [-@igor], Dow [-@dow2012], Amado [-@amado2006] e outros autores se repetem no meio urbano? Há diferenças quantitativas e qualitativas na oferta de crédito entre distritos de um mesmo município? Há discriminação na oferta de serviços financeiros entre regiões periféricas e centrais de uma metrópole? Volume e qualidade do crédito impactam na renda per capita dos bairros/distritos da cidade?

Diante dos questionamentos e da lacuna literária, o presente trabalho pretende aprofundar as discussões sobre centralidade financeira no espaço urbano, por meio de uma análise espacial empírica e exploratória do setor bancário do município de São Paulo, em 2010. Essa análise é importante para compreender como a oferta de crédito está dispersa no espaço e como ela influencia o desenvolvimento econômico e social das cidades, servindo de base para formulação de políticas de desenvolvimento regional no combate às desigualdades regionais.

Para atingir esses objetivos será necessário construir uma base de dados com os arquivos disponibilizados mensalmente pelo BACEN da estatística bancária de cada agência (ESTBAN) e georreferenciar esses dados. Com isso, será possível agrupar os dados por setor censitário da malha territorial de São Paulo (IBGE) e cruzar com os dados de renda e domicílio do CENSO 2010. Depois, calcularemos alguns índices de localização, distribuição, qualidade e diversidade do crédito, que serão apresentados na seção de metodologia. Em seguida, realizaremos uma análise exploratória desses dados, por meio de técnicas de clusters e análise de componentes principais. Além disso, estimaremos um modelo econométrico espacial (SLX) com os índices criados para mensurar o impacto da oferta de crédito local e dos vizinhos mais próximos na renda per capita das regiões. Por fim, avaliaremos e discutiremos os resultados encontrados, sob o referencial pós-keynesiano.

Esse trabalho divide-se em 5 capítulos, incluindo essa introdução. No próximo, são tratados os aspectos teóricos importantes para a análise exploratória e empírica que será realizada neste trabalho, abordando os fundamentos de Economia Monetária 
de Produção, da caracterização de Centro e Periferia e das principais questões existentes sobre os Serviços financeiros no meio urbano. A metodologia é apresentada no terceiro capítulo, subdividida em seções para tratar separadamente a fonte dos dados e cada um dos métodos utilizados. No capítulo 4 são apresentados os resultados, discutindo-os. Por fim, são apresentadas as considerações finais do trabalho.

# ASPECTOS TEÓRICOS

## *Economia Monetária de Produção*

Segundo Keynes [-@keynes73b], vivemos em uma economia monetária de produção, em que a moeda exerce papel fundamental nas decisões econômicas dos agentes, pois empresários decidem produzir e contratar fatores de produção com expectativa de ganhar dinheiro com sua produção. Como não há nenhum mecanismo que garanta que a contratação de fatores será totalmente compensada pela venda do produto gerado e, considerando um contexto de incerteza sobre o futuro, os agentes podem optar por não gastar esse ativo, mantendo-o na sua forma líquida.

Dessa forma, em uma economia monetária, o empresário possui interesse no dinheiro que será gerado a partir de suas atividades produtivas. Seu objetivo principal é aumentar sua riqueza de forma geral, ou seja, em sua forma monetária. Ele tomará a decisão de expandir sua produção se acreditar que isso resultará em um aumento de sua renda. A escolha entre oferecer ou não trabalho é, na verdade, uma decisão sobre como utilizar sua riqueza, seja investindo-a na produção ou mantendo-a na forma mais líquida (mantendo em dinheiro). Nesse tipo de economia, o produtor não é guiado pelo volume de produto que espera obter, mas sim pelas oportunidades alternativas de aumentar ou preservar sua riqueza [@keynes73a].

Carvalho [-@carvalho92] apresentou uma síntese das características de uma economia monetária de produção, elencando seis princípios fundamentais de sua operação que garantem à moeda as funções de reserva de valor e de liquidez:

- (i) Princípio da produção: o objetivo das firmas é gerar lucro monetário, o interesse não está na quantidade de produto produzida, mas no montante de dinheiro gerado.

- (ii) Princípio da dominância estratégica: dada a escassez do capital em relação ao trabalho, trabalhadores e empresas encontram-se em condições desiguais no mercado, o que também é válido para o mercado de crédito, pois o poupador não consegue induzir o empresário a se endividar. Porém, no que diz respeito à obtenção de crédito, as empresas têm mais sucesso, mesmo que precisem oferecer taxas de juros mais altas aos potenciais credores. Isso demonstra claramente a predominância das empresas nos mercados.

- (iii) Príncipio da temporalidade: O princípio da temporalidade na atividade econômica estabelece uma ordem sequencial no processo produtivo: a decisão de produzir ocorre antes da produção em si, que por sua vez precede a venda. Esse princípio é fundamentado na ideia de tempo histórico, irreversível, adotado pelos teóricos pós-keynesianos. Essa concepção reconhece o tempo como uma entidade contínua, sempre avançando do passado em direção ao futuro. Em outras palavras, as decisões tomadas em um determinado momento do tempo não podem ser desfeitas e têm implicações para o futuro.

- (iv) Princípio da não-ergodicidade (da incerteza): o sistema econômico caminha, ao longo do tempo, de um passado irrevogável para um futuro incerto, estatisticamente imprevisível.

- (v) Princípio da não pré-conciliação dos planos: não existe um plano perfeito que possa coordenar todos os mercados e determinar exatamente a quantidade a ser produzida com base na demanda futura. Os agentes econômicos podem tentar reduzir a incerteza recorrendo a contratos futuros denominados em moeda. Esses contratos permitem que os agentes fixem acordos antecipados para a compra ou venda de determinados bens ou serviços, proporcionando algum grau de segurança em relação às transações futuras.

- (vi) Princípio das propriedades da moeda: Para que seja possível a realização de contratos futuros denominados em moeda, a moeda deve possuir duas propriedades fundamentais: elasticidade de produção e substituição próximas de zero. Essas características garantem à moeda sua função como reserva de valor e liquidez. Ao afirmar que a elasticidade de produção e substituição da moeda é próxima de zero, significa que um aumento na demanda por moeda não resulta em um aumento em sua disponibilidade e que nenhuma outra forma de ativo pode desempenhar suas funções. Dessa forma, a moeda adquire um caráter único e essencial na economia capitalista.

## *Centro e periferia*

Após uma análise dos elementos fundamentais das economias monetárias de produção, é possível realizar uma caracterização geral entre economias centrais e periféricas. Ao comparar essas economias, pode-se observar que as economias centrais tendem a ter trajetórias de crescimento mais estáveis, com a variável dinâmica sendo endógena. Além disso, apresentam uma menor propensão a importar, instituições mais desenvolvidas, mercados com maior liquidez de ativos e bases sólidas para a disseminação de informações. Isso resulta em um menor nível de incerteza. Em termos de estrutura produtiva, nas economias centrais a produção está concentrada principalmente nos setores secundário e terciário. Já nas economias periféricas, a produção se concentra nos setores primário e terciário [@dow82].

Ao analisar a caracterização geral das economias centrais e periféricas, fica evidente uma tendência de maior preferência pela liquidez nas economias periféricas em comparação com as centrais. Isso ocorre devido à maior incerteza e à menor desenvoltura dos arranjos institucionais nas periferias. Consequentemente, a criação de meios de pagamento nessas economias pode enfrentar desafios, uma vez que os multiplicadores são menores devido à preferência pela liquidez mais pronunciada por parte dos agentes na periferia. É importante ressaltar que, ao contrário dos multiplicadores nacionais, os multiplicadores regionais são fortemente influenciados pelos vazamentos no fluxo financeiro entre diferentes regiões. Esses vazamentos podem ser de natureza real, como o saldo comercial, ou de natureza financeira, como as transações na conta de capitais. De todo modo, ambos tendem a drenar liquidez das economias periféricas em direção às economias centrais [@chick88].

Para Amado [-@amado2006], os bancos são fundamentais nesse contexto, pois são os principais criadores de liquidez. Sendo assim, a autora defende que uma análise que procure observar o comportamento dos agentes em relação à moeda e aos limites que a liquidez pode gerar ao processo de crescimento de determinada economia deve ter por base a análise do comportamento dos bancos como criadores de liquidez.

Sobre a tendência ao dreno de liquidez das regiões periféricas para as centrais, Dow [-@dow82] pontua dois problemas vividos pelos bancos na periferia: (i) perdem reservas continuamente para o centro e (ii) perdem mais reservas que os bancos do centro para o público em geral, já que este tem maior demanda por liquidez. Desse modo, tanto há problemas com o multiplicador bancário quanto com o multiplicando, e ambos tendem a limitar a criação de liquidez.

Pensando que a liquidez é o primeiro limite à decisão de investir, o processo de crescimento da periferia será impedido por um limite de liquidez e o crescimento do centro é facilitado pelo mesmo motivo.

Amado [-@amado2006] verificou um processo de concentração bancária e financeira (fusões bancárias) nos anos 1990, que prejudicou diretamente as economias periféricas, ao reforçar as restrições de liquidez que essas economias enfrentam. De acordo com a autora, as economias periféricas sofrem constantes vazamentos em seus fluxos financeiros. Esses vazamentos são drenados para as regiões centrais, que passam a apresentar vantagens comparativas em relação à periferia, por terem acesso a um volume maior de liquidez. Dessa forma, os bancos centrais ficam mais receosos em estender crédito à periferia, por terem expectativas menos sólidas em relação a essas regiões. Além disso, os bancos da periferia tendem a estender crédito a atividades que sejam mais fortemente relacionadas com a própria região, com intuito de evitar perda de reservas. Para Amado [-@amado2006], esse processo de concentração levará os bancos que assumem os bancos regionais a redirecionar suas atividades para as regiões em que possuem vantagens comparativas, como aconteceu com três bancos de caráter regional que foram absorvidos por bancos das regiões centrais: Econômico pelo Excel, Banorte pelo Bandeirantes e Bamerindus pelo HSBC.

Martin e Sunley [-@martin2015] destacam que o acesso das empresas a empréstimos financeiros varia de acordo com a localidade, principalmente devido às práticas discriminatórias das instituições bancárias em relação ao financiamento. Dessa forma, empresas localizadas em regiões economicamente deprimidas podem ser consideradas de alto risco pelas instituições financeiras, resultando na recusa de crédito. O que reforça a importância dos bancos de caráter regional.

De acordo com Selmier [-@selmier2016], essa característica é crucial para entender a capacidade do sistema bancário brasileiro de manter altas taxas de lucro. O autor destaca que ao longo do tempo, o sistema bancário do Brasil tem sido dominado por quatro grandes bancos. Essa estrutura de mercado oligopolizada proporciona estabilidade, uma vez que os lucros dos grandes bancos são sustentados, permitindo que eles se concentrem em seus mercados domésticos. Selmier [-@selmier2016] afirma que os "Big Four" do Brasil apresentam margens de lucro e de juros líquidos igualmente elevadas.

## *O papel da centralidade no meio urbano*

Além da diferenciação entre centro e periferia, é importante compreender a dinâmica espacial dos serviços financeiros. Parr e Budd [-@parr] se baseiam na Teoria do Lugar Central, desenvolvida por Christaller [-@christaller], para explicar a localização dos serviços financeiros.

A Teoria do Lugar Central foi originalmente desenvolvida para explicar a localização de atividades de varejo e não de serviços financeiros. No entanto, a Teoria do Lugar Central pode ser útil para entender a organização espacial de serviços financeiros, especialmente em relação à hierarquia urbana e à distribuição de centros financeiros em diferentes níveis de centros urbanos. Segundo Crocco [-@crocco2010], a centralidade de uma região, que depende de fatores como tamanho da população, renda e diversidade industrial, pode influenciar a atividade bancária na região.

Parr e Budd [-@parr] argumentam que as economias de escala e escopo desempenham um papel significativo na decisão de onde uma atividade no setor financeiro deve ser localizada. Isso tem um impacto crucial nos mercados financeiros, instituições intermediárias e produtos financeiros, resultando em efeitos notáveis na eficácia estratégica e comparativa das atividades financeiras. Além disso, esses fatores também restringem o número de locais disponíveis para a prestação de determinados serviços financeiros.

Memarian *et al*. [-@memarian2023] mostram que a informação, crucial para a tomada de decisões nos mercados financeiros, não é facilmente transferível pelo espaço, e os centros urbanos se beneficiam das economias de aglomeração e do fluxo de informações facilitado, o que reduz os custos de globais de transação, a assimetria de informações e os riscos de risco moral. O que corrobora com a tese de que há formação de centros financeiros nos centros urbanos.

Embora o acesso ao crédito para as empresas seja facilitado pela formação das centralidades no centro urbano [@memarian2023; @lee2018; @wood2005], a grande concentração financeira pode desfavorecer o público periférico, que enfrentará maiores problemas de acesso, devido aos maiores custos de transação e transporte, já que muitos dos serviços financeiros só podem ser contratados de forma presencial, exigindo um contato face-a-face.

Mesmo em grandes centros urbanos, com alta densidade populacional, há heterogeneidade espacial, como demonstrado por Memarian *et al.* [-@memarian2023], que utilizaram imagens de satélites para identificar obstáculos de transporte e de crescimento da malha urbana. Outros estudos, como os de Pereira *et al.*[-@pereira2019desigualdades] e Pereira [-@pereira_distributive_2018] mostram como o acesso a oportunidades urbanas é desigual e como há diferentes custos de transportes envolvidos para atingir as oportunidades (dentre elas, as financeiras), que estão concentradas no centro.

# METODOLOGIA

## *Fonte dos dados*

Para que fosse possível uma análise espacial empírica e exploratória da atividade bancária no meio urbano, foi construída uma base de dados inédita, que integra conjuntos de informações provenientes de várias fontes, a saber:

ESTBAN: subsistema estatístico do Sistema COSIF que disponibiliza arquivos gerados mensalmente com a informação da Estatística Bancária Mensal, contendo a posição mensal dos saldos das principais rubricas de balancetes dos bancos comerciais e dos bancos múltiplos com carteira comercial[^1].

[^1]: https://www4.bcb.gov.br/fis/cosif/estban.asp?frame=1

Relação de Agências - BCB: arquivos com informações sobre todas as agências do Brasil, disponibilizados pelo Banco Central do Brasil e extraídos do Sistema de Informações sobre Entidades de Interesse do Banco Central -- UNICAD, mensalmente. Contém informações como endereço completo e CNPJ de cada agência[^2].

[^2]: https://www.bcb.gov.br/fis/info/agencias.asp?frame=1

Google Maps API: Os endereços das agências foram submetidos à API do Google Maps, com intuito de georreferenciar a base, obtendo latitude e longitude de cada agência da Relação de Agências[^3].

[^3]: Vale destacar que foram encontrados endereços de agências incorretos nos dados disponibilizados pelo BCB, o que resultou em um georreferenciamento incorreto. Assumiu-se um erro de apenas 5% dos dados nesse procedimento.

Malha territorial do município de São Paulo, dividida em setores censitários (e por distritos) - IBGE: Foram utilizados alguns *shapefiles* contendo informações vetoriais (polígonos) de cada setor censitário.

Dados de domicílio do CENSO 2010: Foram incluídos dados demográficos e socioeconômicos, agregados por setor censitário, disponibilizados pelo CENSO 2010 para a compreensão do contexto populacional subjacente às análises efetuadas no trabalho.

Para os dados da ESTBAN e da Relação de Agências - BCB, foi desenvolvido um *script* em Python para automatizar o processo de download, descompactação, leitura dos arquivos .csv ou .xls, transformação (padronização de nome e ordem de colunas), enriquecimento (dados de geolocalização do Google Maps API) e carregamento em banco de dados adequado para a análise (BigQuery). Para processar o grande volume de arquivos, foi utilizado PySpark [@spark].

Os dados da malha territorial do município de São Paulo foram obtidos através do pacote geobr do R [@geobr], utilizando as funções adequadas.

Por fim, os dados de domicílios do CENSO 2010 foram baixados diretamente do site IBGE Downloads, na seção de "Resultados do Universo" e "Agregados por Setor Censitário" e carregados no R para serem cruzados com os demais dados.

Todos os procedimentos e base de dados desta metodologia são contribuições acadêmicas reprodutíveis e, portanto, estão disponibilizadas para o público no endereço: https://github.com/flaviohugo14/quarto-abnt.

A Figura 1 mostra a localização das agências bancárias no Brasil, resultado do desenvolvimento da base de dados descrita acima.

\fig{Localização das agências bancárias no Brasil (2010).}{fig:brasil}{images/brasil.png}{Elaboração própria.}

## *Tratamento dos dados e construção de índices*

Seguindo o referencial teórico pós-keynesiano de que vivemos em economia monetária de produção, o comportamento dos bancos e do público em relação à alocação de seus ativos pode ser mensurado em termos de preferência pela liquidez. Para tal mensuração, Crocco *et al*. [-@crocco2006] construíram dois indicadores financeiros: preferência pela liquidez do público (PLP) e preferência pela liquidez dos bancos (PLB).

Segundo Crocco *et al*. [-@crocco2006], no balanço dos bancos, a conta de operações de crédito representa a porção de ativos com baixa liquidez relacionada aos empréstimos concedidos. Por outro lado, as contas de depósitos à vista, poupança e depósitos a prazo são registradas no passivo do balanço dos bancos e refletem o comportamento geral do público, agindo como intermediários financeiros. Segundo o enfoque pós-keynesiano, o público realiza suas decisões de alocação de ativos entre as contas mencionadas acima levando em consideração o nível de incerteza e a quantidade de informações disponíveis nas regiões. A decisão de alocação de portfólio envolve a escolha entre manter ativos mais líquidos, com retorno financeiro menor, em situações de maior incerteza econômica, ou optar por ativos menos líquidos, porém com potencial de maior rendimento financeiro, quando o cenário econômico se mostra mais confiável.

Baseado no índice criado pelos autores, pode-se definir o índice de preferência pela liquidez do público (PLP) utilizado neste trabalho:

```{=tex}
\begin{equation}
PLP = \frac{DV}{DT}
\end{equation}
```

$DV =$ depósitos à vista[^4].

[^4]: Na ESTBAN, é a soma das contas agregadas 400 (depósitos à vista do governo), que contém as subcontas: 401 (serviços públicos); 402 (atividades empresariais); 403 (especiais do tesouro nacional); 404 (saldo credores em contas de empréstimos e financiamentos - CFP). E 410 (depósitos à vista privado), que contém as subcontas: 411 (de pessoas físicas); 412 (de pessoas júridicas); 413 (de instituições do sistema financeiro); 414 (judiciais); 415 (obrigatórios); 416 (para investimentos); 417 (vinculados); 418 (demais depósitos); 419 (saldo credores em contas de empréstimos e financiamentos - Outros).

$DT =$ depósitos totais (incluem depósitos a vista, depósitos de poupança[^5] e depósitos interfinanceiros[^6]).

[^5]: Conta 420 da ESTBAN.

[^6]: Conta 430 da ESTBAN, contém as subcontas: 431 (depósitos interfinanceiros), 432 (depósitos a prazo) e 433 (captações no mercado aberto).

Quanto maior esse índice, maior é a preferência pela liquidez do público, pois aloca maior parcela de seus recursos em aplicações de maior liquidez.

Para o índice de preferência de liquidez dos bancos (PLB), Crocco *et al*. [-@crocco2006] diz que o sistema bancário aloca seus recursos entre ativos de maior ou menor liquidez levando em conta o grau de desenvolvimento da região em que se encontra. Dessa forma, utilizaram a conta de operações de crédito para captar a disposição do banco à emprestar, e a conta de depósitos à vista, que representa a intenção do público bancarizado em manter seus ativos mais líquidos possíveis. O objetivo é medir como os bancos gerenciam seus balancetes e sua preferência pela liquidez, tornando seus ativos mais ou menos líquidos de acordo com as características econômicas da região a que pertecem. Neste trabalho, o PLB foi definido como:

```{=tex}
\begin{equation}
PLB = \frac{DV}{OPC}
\end{equation}
```

$DV =$ depósitos à vista.

$OPC =$ operações de crédito[^7].

[^7]: Representa o somatório das seguintes contas da ESTBAN: (161) empréstimos e títulos descontados, (162) financiamentos, (163) financiamentos rurais à agricultura -- custeio/investimento, (164) financiamentos rurais à pecuária - custeio/investimento, (165) financiamentos rurais à agricultura -- comercialização, (166) financiamentos rurais à pecuária -- comercialização, (167) financiamentos agroindustriais, (168) (rendas a apropriar de operações de financiamentos agroindustriais), (169) financiamentos imobiliários, (171) outras operações de crédito, (172) outros créditos, (173) provisão para operações de crédito créditos em liquidação e (176) operações especiais.

Quanto maior o índice, maior a preferência pela liquidez dos bancos, pois estão emprestando menos (ficando com ativos mais líquidos).

É esperado que PLP e PLB sejam mais baixos em regiões mais desenvolvidas, pois o público apresentaria menor preferência pela liquidez o que é sinônimo de prosperidade econômica segundo o arcabouço teórico pós-keynesiano. Da mesma forma, os bancos também terão menor preferência por liquidez e maior disposição à emprestar, dado o desempenho econômico dessas regiões.

Cabe nessa análise, a introdução de um índice inédito na literatura, que complemente o PLB de Crocco *et al*. [-@crocco2006] e torne a preferência pela liquidez dos bancos dependente apenas de variáveis endógenas, ou seja, que considere apenas a escolha dos bancos entre seus ativos e desconsidere os depósitos à vista (variável exógena para os bancos). Isso é importante para que o índice não seja comprometido pelo volume de depósitos do público bancarizado, que tende a ser mais alto em regiões mais desenvolvidas, fazendo com que o PLB de Crocco *et al*. [-@crocco2006] fique alto nessas regiões. Dessa forma, pode-se definir um índicde de preferência pela liquidez dos bancos endógeno (PLBe), como a proporção de ativos líquidos sobre ativos totais:

```{=tex}
\begin{equation}
PLBen = \frac{D + E}{A}
\end{equation}
```

$D + E =$ Disponibilidades[^8] + Empréstimos e Títulos Descontados[^9].

[^8]: Agregado das contas 111 (Caixa), 112 (Depósitos bancários), 113 (Reservas livres em espécie) e 114 (Aplicações temporárias em ouro).

[^9]: Conta 161 da ESTBAN, representam o crédito mais líquido dentro das operações de crédito.

$A =$ Total do ativo[^10].

[^10]: Conta 399 da ESTBAN, contendo o somatório de todas as contas do ativo.

Com interpretação semelhante ao PLB, espera-se que o PLBe seja menor em regiões mais desenvolvidas.

Para mensurar a concentração, as centralidades financeiras e a desigualdade na oferta de crédito, calculou-se também alguns índices inpirados no "quociente locacional", como fez Tupy [-@igor], comparando a participação no crédito nacional de uma microrregião, com sua participação relativa no PIB nacional. Esse índice foi chamado de Índice Regional de Crédito (IRC), definido como:

```{=tex}
\begin{equation}
IRC_{i} = \frac{\frac{cred_i}{\sum_{i=1}^n cred_i}}{\frac{pib_i}{\sum_{i=1}^n pib_i}}
\end{equation}
```
Aqui, utilizou-se a renda dos setores censitários no lugar do PIB, para identificar os padrões de concentração de dispersão do crédito no meio urbano. Além disso, diferentes tipos de contas de crédito foram incorporadas para criar outros índices baseados no IRC, com a finalidade de comparar qualitativamente os padrões de concentração e dispersão de cada tipo de crédito (a referência da conta da ESTBAN foi mencionada entre parênteses). São eles:

-   O próprio Índice Regional de Crédito (IRC):

```{=tex}
\begin{equation}
IRC_{i} = \frac{\frac{OPC_i}{\sum_{i=1}^n OPC_i}}{\frac{renda_i}{\sum_{i=1}^n renda_i}}
\end{equation}
```
$OPC_i =$ Operações de crédito (160) ofertadas no distrito $i$.

$renda_i =$ Renda nominal do distrito $i$.

-   Índice Regional de Empréstimos (IRE):

```{=tex}
\begin{equation}
IRE_{i} = \frac{\frac{E_i}{\sum_{i=1}^n E_i}}{\frac{renda_i}{\sum_{i=1}^n renda_i}}
\end{equation}
```
$E_i =$ Empréstimos ofertados (161) no distrito $i$.

$renda_i =$ Renda nominal do distrito $i$.

-   Índice Regional de Financiamentos (IRF):

```{=tex}
\begin{equation}
IRF_{i} = \frac{\frac{F_i}{\sum_{i=1}^n F_i}}{\frac{renda_i}{\sum_{i=1}^n renda_i}}
\end{equation}
```
$F_i =$ Financiamentos ofertados (162) no distrito $i$.

$renda_i =$ Renda nominal do distrito $i$.

-   Índice Regional de Lucro bancário (IRL):

```{=tex}
\begin{equation}
IRL_{i} = \frac{\frac{L_i}{\sum_{i=1}^n L_i}}{\frac{renda_i}{\sum_{i=1}^n renda_i}}
\end{equation}
```
$L_i =$ Total das contas de resultado (710) no distrito $i$.

$renda_i =$ Renda nominal do distrito $i$.

-   Índice Regional de Depósitos:

```{=tex}
\begin{equation}
IRD_{i} = \frac{\frac{DV_i}{\sum_{i=1}^n DV_i}}{\frac{renda_i}{\sum_{i=1}^n renda_i}}
\end{equation}
```
$DV_i =$ Depósitos à vista no distrito $i$.

$renda_i =$ Renda nominal do distrito $i$.

-   Índice Regional de Risco (IRR):

```{=tex}
\begin{equation}
IRR_{i} = \frac{\frac{PC_i}{\sum_{i=1}^n PC_i}}{\frac{renda_i}{\sum_{i=1}^n renda_i}}
\end{equation}
```
$PC_i =$ Provisão de crédito (174) no distrito $i$.

$renda_i =$ Renda nominal do distrito $i$.

Se os índices definidos acima são iguais a 1, a participação distrito $i$ no total da conta analisada é idêntica à sua participação na renda global. Se os índices recebem valores menores que 1, indica que o distrito $i$ participa menos do que o proporcial à sua participação na renda do que a conta analisada. Para o IRC, IRE, IRF, significaria menos crédito, empréstimo e financiamento, comparado a participação na renda global. Para valores maiores que 1, signifaria que a região recebe mais crédito do que participa da renda global [@igor]. A análise é semelhante para IRD, IRR e IRL, mas aqui, a precupação é com a distribuição dos depósitos em relação a distribuição da renda (IRD), com a percepção de risco que os bancos têm com cada região (IRR), e a distribuição dos lucros bancários em termos de resultado, comparada à distribuição da renda entre os setores censitários.

Além desses índices de concentração e centralidade, foi calculado um índice de concentração de operações de crédito e um índice de concentração do setor bancário, ambos baseados no Índice de Hirschman-Herfindahl (IHH):

Índice de concentração de operações (ICO): Consiste na soma de quadrados da participação relativa de todas as $N$ operações possíveis ofertadas no distrito: Empréstimos e Descontos de Títulos (161), Financiamentos (162), Financiamentos rurais à agricultura -- custeio/investimento (163), Financiamentos rurais à pecuária - custeio/investimento (164), Financiamentos rurais à agricultura -- comercialização (165), Financiamentos rurais à pecuária -- comercialização (166), Financiamentos agroindustriais (167_168), Financiamentos Imobiliários (169), Outras Operações de crédito (172), Outros créditos (173) e Arrendamento Mercantil (180). Pode ser calculado como:

```{=tex}
\begin{equation} \label{eq:ico}
ICO_{j} = \sum_{i=1}^N \Bigl(\frac{OP_{ij}}{OPC_{j}}\Bigr)^2
\end{equation}
```
$OP_{ij} =$ Operação de crédito $i$ na região $j$ (Dentre as citadas acima).

$OPC_{j} =$ Total das operações de crédito na região $j$

$N =$ Número de operações totais.

Índice de concentração do setor bancário (ICB): Consiste na soma de quadrados da participação relativa de todos os $N$ bancos (conglomerados) do setor bancário que operam no distrito, pode ser calculado como:

```{=tex}
\begin{equation}
ICB_{j} = \sum_{i=1}^N \Bigl(\frac{x_{ij}}{x_{j}}\Bigr)^2
\end{equation}
```
$x_{ij} =$ Operação de crédito do banco (conglomerado) $i$ na região $j$ (Dentre as citadas acima).

$x_{j} =$ Total das operações de crédito na região $j$.

$N =$ Número de conglomerados.

Quando todos os $N$ bancos possuem a mesma participação de mercado, o índice de concentração do setor bancário atinge o seu valor mínimo, que é $ICB = \frac{1}{N}$. Por outro lado, no caso oposto, em que uma única instituição atua como um monopolista e detém todo o mercado de serviços bancários, o índice de concentração atinge o seu valor máximo, que é igual a $1$ [@igor; @paula]. O mesmo vale para operações de crédito, quando elas são bem diversificadas e apresentam a mesma distribuição, tem-se que $ICO = \frac{1}{N}$, enquanto uma baixa diversificação aproxima cada vez mais o índice à $ICO = 1$. Esses índices serão utilizados para mensurar a qualidade e a diversidade do mercado de crédito nas regiões.

## *Análise de Componentes Principais*

Após a criação das variáveis e dos índices, será utilizada uma técnica estatística de análise multivariada: a análise de componentes principais (ACP).

A técnica de ACP tem como objetivo construir um conjunto de variáveis estatisticamente independentes, formadas a partir de uma transformação linear do conjunto de variáveis e reduzir a dimensão da base de dados perdendo o mínimo de informação (variância) possível [@mingotti].

Segundo Andrade [-@andrade], com $n$ variáveis, pode-se gerar até $n$ componentes. No entanto, quando há alta correlação entre as variáveis, o número de componentes necessários à explicação da maior parte da variância dos dados resume-se em a poucos componentes. Dessa forma, podemos até utilizar de técnicas de análise univariada, caso seja possível condensar as $n$ variáveis em poucos componentes.

Pretende-se criar, portanto, alguns índices de centralidade e qualidade financeira, que resumam o grande número de variáveis da base de dados original, juntamente com os índices criados na seção 3.2. Esses índices serão utilizados no modelo de Econometria de Espacial, definido na seção 3.4.

## *Análise Espacial*

Todo o processo que se dá no espaço está sujeito à chamada Lei de Tobler, conhecida como a Primeira Lei da Geografia, que diz que "tudo depende de todo o restante, porém o que está mais próximo depende mais do que aquilo que está mais distante" [@almeida]. Logo, a proximidade influencia a interação dos agentes no espaço, de forma a tornar a distribuição dos eventos espaciais não-aleatórios. A análise espacial, portanto, consiste em revelar e interpretar essas relações de proximidade e influência entre regiões vizinhas.

A Econometria Espacial, por sua vez, é um ramo da econometria convencional, tendo como escopo, estimar, testar e prever modelos teóricos, influenciados pelos efeitos espaciais [@almeida]. O Modelo Clássico de Regressão Linear (MCRL) tem a limitação de não ser capaz de controlar esses efeitos espaciais e, portanto, deve ser relaxado para incorporar tais efeitos.

Segundo Almeida [-@almeida], os processos espaciais de dependência espacial, ou seja, aqueles em que uma variável aleatória $y_i$ da região $i$ é influenciada pela variável $y_j$ da região vizinha $j$, são classificados como Processos Autorregressivos Espaciais (SAR). Para análise desse tipo de processo, é realizada uma defasagem espacial sobre uma variável $y$ aleatória da média da vizinhaça ponderada por uma matriz de pesos espaciais $W$. O modelo SAR, em sua versão pura, é expresso como a seguir:

```{=tex}
\begin{equation}
y = \rho Wy + \varepsilon
\end{equation}
```
Em que $Wy$ é um vetor $n$ por 1 de defasagens espaciais para a variável dependente, $\rho$ é o coeficiente autorregressivo espacial e $\varepsilon$ é o vetor de termos de erro.

A versão mista do modelo SAR, incorpora também uma matriz $X$ de variáveis exógenas:

```{=tex}
\begin{equation}
y = \rho Wy + X \beta + \varepsilon
\end{equation}
```
Já os processos espaciais em que há influência de algo que não é capaz de ser modelado, podem ser encorporados na estrutura dos erros do modelo. Esses processos podem ser análisados pelo Modelo de Erro Autorregressivo Espacial (SEM), expresso por:

```{=tex}
\begin{equation}
y = X \beta + \xi
\end{equation}
```
```{=tex}
\begin{equation}
\xi = \lambda W \xi + \varepsilon
\end{equation}
```
Rearranjando:

```{=tex}
\begin{equation}
y = X \beta + (I_n - \lambda W)^{-1}\varepsilon
\end{equation}
```

Para analisar os transbordamentos espaciais dos processos financeiros e seu impacto na economia real, pode-se utilizar o Modelo Regressivo Cruzado Espacial (SLX), que considera os transbordamentos espaciais localizados das variáveis explicativas sobre a variável dependente:

```{=tex}
\begin{equation}
y = X\beta + WX \tau + \varepsilon
\end{equation}
```

Para os efeitos globais, pode-se utilizar o modelo de Durbin espacial ou modelo SDM, que incorpora também a difusão espacial da variável dependente:

```{=tex}
\begin{equation}
y = \rho Wy + X\beta + WX \tau + \varepsilon
\end{equation}
```

Como a demanda por crédito é global e sua oferta é local, é esperado que haja vazamentos de uma região para outra, portanto, os modelos SLX e SDM parecem mais adequados para analisar o impacto em variáveis reais, como a Renda per capita. 

A matriz de pesos espaciais $W$ escolhida será a que maximiza o coeficiente de correlação espacial I de Moran:

```{=tex}
\begin{equation}
I = \frac{n}{\sum_i\sum_j w_{ij}}\frac{\sum_{i}\sum_{j} w_{ij}z_i z_j}{\sum_{i=1}^n z_{i}^2}
\end{equation}
```
Em que $n$ é o número de regiões, $z$ denota os valores da variável de interesse padronizada e $w_{ij}$ os pesos espaciais, que descrevem as interações entre as regiões $i$ e $j$ [@almeida].

Por fim, a expectativa é de que seja possível constatar correlação espacial nos processos financeiros e aglomeração da atividade bancária nas regiões centrais.

```{r echo=FALSE, warning=FALSE, message=FALSE}
library(bigrquery)
library(geobr)
library(ggplot2)
library(dplyr)
library(sf)
library(stringr)
library(readxl)
library(ggspatial)
library(extrafont)
library(cowplot)
library(stargazer)
library(psych)
library(huxtable)
library(magrittr)
library(spatialreg)
```

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=FALSE}
# Download ESTBAN data from BigQuery
project_id <- "cloud-learning-doing"

sql <- "SELECT * FROM estban.estban_agencias_geolocalizadas WHERE data_base = '2010-12-01'"

query <- bigrquery::bq_project_query(
  project_id,
  sql,
)

agencias_2010 <- bigrquery::bq_table_download(query)
```

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=FALSE}
# Download and write shapefiles

# Setores censitários do estado de São Paulo
sp_ct <- geobr::read_census_tract(35, showProgress = FALSE, simplified = FALSE)

# Distritos geograficamente definidos de todo Brasil
br_bairros <- geobr::read_neighborhood(2010, showProgress = FALSE, simplified = FALSE)
```

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=FALSE}
# Distritos da cidade de São Paulo
sp_bairros <- br_bairros |> dplyr::filter(code_muni == "3550308")

# Setores censitários da cidade de São Paulo
sp_ct_capital <- sp_ct |> dplyr::filter(code_muni == "3550308")

# Polígono do município de São Paulo
sp_capital <- geobr::read_municipality(code_muni = 3550308, showProgress = FALSE)

# library(h3)
# 
# hex <- h3::geo_to_h3(centroids, res = 7)
# hex_map <- h3::h3_to_geo_boundary_sf(hex) |> st_transform(4674)
# 
# sp_ct_capital$area <- sp_ct_capital |> st_area() |> as.numeric()
# 
# 
# st_intersection(hex_map[1,1], sp_ct_capital) |>
#   mutate(intersect_area = sf::st_area(.),
#          pct_intersect = intersect_area / area)
```

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=FALSE}
# Apenas bancos contidos no território da cidade de São Paulo.

agencias_2010_sp <- agencias_2010 |>
  dplyr::filter(!is.na(lat) & !is.na(lng)) |>
  sf::st_as_sf(coords = c("lng", "lat"), crs = 4674) |>
  sf::st_filter(sp_capital) |>
  dplyr::filter(uf == "SP")

agencias_2010_sp |> sf::write_sf("data/agencias/agencias.shp")
```

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=FALSE}
# Dados do CENSO 2010 agregados por setor censitário

renda_sp_capital <- read.csv("data/DomicilioRenda_SP1.csv", sep = ";") |>
  dplyr::mutate(code_tract = as.character(Cod_setor)) |>
  dplyr::filter(V002 != "X")

populacao_sp_capital <- readxl::read_xls("data/Basico_SP1.xls") |>
  dplyr::mutate(code_tract = as.character(Cod_setor)) |>
  dplyr::select(c("code_tract", "V002")) |>
  dplyr::filter(V002 != "X")

domicilios_sp_capital <- readxl::read_excel("data/Domicilio01_SP1.xls") |>
  dplyr::mutate(code_tract = as.character(Cod_setor)) |>
  dplyr::select(
    c(
      "code_tract",
      "V001",
      "V002",
      "V003",
      "V004",
      "V005",
      "V006",
      "V007",
      "V008",
      "V009",
      "V010",
      "V011",
      "V012",
      "V017",
      "V024",
      "V043"
    )
  )

domicilios_sp_capital$domicilios <- as.numeric(domicilios_sp_capital$V002)

domicilios_sp_capital$agua_encanada <- as.numeric(domicilios_sp_capital$V012)
domicilios_sp_capital$esgoto <- as.numeric(domicilios_sp_capital$V017)
domicilios_sp_capital$domicilios_com_banheiro <- as.numeric(domicilios_sp_capital$V024)
domicilios_sp_capital$energia_eletrica <- as.numeric(domicilios_sp_capital$V043)

renda_sp_capital$renda_nominal <- as.numeric(renda_sp_capital$V002) +
  as.numeric(renda_sp_capital$V003) +
  as.numeric(renda_sp_capital$V004)

populacao_sp_capital$populacao <- as.numeric(populacao_sp_capital$V002)
```

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=FALSE}
# Adicionando dados de renda e população do CENSO 2010 aos shapefiles por setor censitário

sp_ct_capital <- sp_ct_capital |>
  dplyr::left_join(
    renda_sp_capital,
    by = "code_tract"
  ) |>
  dplyr::left_join(
    populacao_sp_capital,
    by = "code_tract"
  ) |>
  dplyr::left_join(
    domicilios_sp_capital,
    by = "code_tract"
  )

# Agrupando por bairro

sp_capital_bairros <- sp_ct_capital |>
  sf::st_drop_geometry() |>
  dplyr::group_by(code_district) |>
  dplyr::summarise(
    renda_nominal = sum(ifelse(is.na(renda_nominal), 0, renda_nominal)),
    populacao = sum(ifelse(is.na(populacao), 0, populacao)),
    domicilios = sum(ifelse(is.na(populacao), 0, domicilios)),
    agua_encanada = sum(ifelse(is.na(populacao), 0, agua_encanada)),
    esgoto = sum(ifelse(is.na(populacao), 0, esgoto)),
    banheiro = sum(ifelse(is.na(populacao), 0, domicilios_com_banheiro)),
    energia_eletrica = sum(ifelse(is.na(populacao), 0, energia_eletrica))
  )

# Juntando com shapefile por bairro

shape_censo_bairros <- sp_bairros |> dplyr::left_join(sp_capital_bairros, by = "code_district")

# Juntando com os dados das agências bancárias de São Paulo (junção geográfica)

shape_censo_agencias_bairros <- sf::st_join(shape_censo_bairros, agencias_2010_sp)
```

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=FALSE}
# Agregando as contas por bairro e removendo bairros sem população (rurais).
# Dataframe próprio para análise.

shape_final <- shape_censo_agencias_bairros |>
  dplyr::group_by(code_district) |>
  dplyr::summarise(
    disponibilidades = sum(`110`),
    op_cred = sum(`160`),
    emprestimos = sum(`161`),
    fin = sum(`162`),
    fin_agricultura_inv = sum(`163`),
    fin_pecuaria_inv = sum(`164`),
    fin_agricultura_com = sum(`165`),
    fin_pecuaria_com = sum(`166`),
    fin_agroindustrial = sum(`167_168`),
    fin_imobiliarios = sum(`169`),
    outras_op_cred = sum(`172`),
    outros_cred = sum(`173`),
    arr_mercantial = sum(`180`),
    provisao_arr_mercantil = sum(`184`),
    provisao_de_credito = sum(`174`),
    ativos = sum(`399`),
    depositos = sum(`401_402_404_411_412_413_414_415_416_417_418_419`),
    poupanca = sum(`420`),
    depositos_inter = sum(`430`),
    relacoes_interfinanceiras = sum(`444_445_446_447_456_458`),
    resultado = sum(`710`),
    renda = max(renda_nominal),
    populacao = max(populacao),
    agua_encanada = max(agua_encanada),
    esgoto = max(esgoto),
    banheiro = max(banheiro),
    energia_eletrica = max(energia_eletrica)
  ) |>
  dplyr::filter(populacao > 0)

# Substituindo NA por 0

shape_final[is.na(shape_final)] <- 0
```

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=FALSE, eval=FALSE}
# Indicadores

# RPC
shape_final$rpc <- shape_final$renda / shape_final$populacao


# IRC
credito_total <- sum(shape_final$op_cred)
renda_total <- sum(shape_final$renda)

shape_final$IRC <- (shape_final$op_cred/credito_total)/(shape_final$renda/renda_total)


# IRE
emprestimo_total <- sum(shape_final$emprestimos)
shape_final$IRE <- (shape_final$emprestimos/emprestimo_total)/(shape_final$renda/renda_total)

# IRF
financiamento_total <- sum(shape_final$fin)
shape_final$IRF <- (shape_final$fin/financiamento_total)/(shape_final$renda/renda_total)

# IRL
resultado_total <- sum(shape_final$resultado)
shape_final$IRL <- (shape_final$resultado/resultado_total)/(shape_final$renda/renda_total)

# IRD
deposito_total <- sum(shape_final$depositos)
shape_final$IRD <- (shape_final$depositos/deposito_total)/(shape_final$renda/renda_total)

# PLP
shape_final$PLP <- ifelse((shape_final$depositos + shape_final$poupanca + shape_final$depositos_inter) == 0, 0, shape_final$depositos/(shape_final$depositos + shape_final$poupanca + shape_final$depositos_inter))

# ROA
shape_final$ROA <- ifelse(shape_final$ativos == 0, 0, shape_final$resultado/shape_final$ativos)

# PLB
shape_final$PLB <- ifelse(shape_final$op_cred == 0, 0, (shape_final$depositos)/(shape_final$op_cred))

# PLBe
shape_final$PLBe <- ifelse(shape_final$ativos == 0, 0, (shape_final$disponibilidades + shape_final$emprestimos)/(shape_final$ativos))

# IRR
provisao_total <- sum(abs(shape_final$provisao_de_credito))
shape_final$IRR <- (abs(shape_final$provisao_de_credito)/shape_final$op_cred)/(shape_final$renda/renda_total)


# Índice de Herfindahl - Operações

QS <- (
  (shape_final$emprestimos) +
    (shape_final$fin) +
    (shape_final$fin_agricultura_inv) +
    (shape_final$fin_pecuaria_inv) +
    (shape_final$fin_agricultura_com) +
    (shape_final$fin_pecuaria_com) +
    (shape_final$fin_agroindustrial) +
    (shape_final$fin_imobiliarios) +
    (shape_final$outras_op_cred) +
    (shape_final$outros_cred) +
    (shape_final$arr_mercantial)
)^2

SQ <- (shape_final$emprestimos)^2 +
  (shape_final$fin)^2 +
  (shape_final$fin_agricultura_inv)^2 +
  (shape_final$fin_pecuaria_inv)^2 +
  (shape_final$fin_agricultura_com)^2 +
  (shape_final$fin_pecuaria_com)^2 +
  (shape_final$fin_agroindustrial)^2 +
  (shape_final$fin_imobiliarios)^2 +
  (shape_final$outras_op_cred)^2 +
  (shape_final$outros_cred)^2 +
  (shape_final$arr_mercantial)^2

shape_final$ICO <- ifelse(QS == 0, NA, SQ/QS)

# Criando novo dataframe para criar Índice de Concentração Bancária (ICB)
new_df <- sf::st_join(sp_bairros, agencias_2010_sp) |> dplyr::filter(!is.na(cnpj))

# CNPJs distintos
cnpjs_distintos <- paste("cnpj_", unique(new_df$cnpj), sep="")

# Pivotando operações de crédito por CNPJ e juntando com o shape de bairros de São Paulo 
pivoted <- new_df |>
  sf::st_drop_geometry() |>
  tidyr::pivot_wider(names_from = cnpj, values_from = `160`, names_prefix = "cnpj_") |>
  dplyr::select(all_of(c("code_district", cnpjs_distintos))) |>
  dplyr::right_join(sp_bairros, by = "code_district") |>
  dplyr::mutate(across(where(is.numeric), ~ifelse(is.na(.), 0, .)))

# Somando os valores de cada coluna (CNPJ) agrupando por bairro.
grouped <- pivoted |>
  dplyr::group_by(code_district) |>
  dplyr::summarise(dplyr::across(starts_with("cnpj"), sum, na.rm = TRUE))

# Calculando ICB
grouped$ICB <- rowSums(grouped[, startsWith(names(grouped), "cnpj_")]^2)/rowSums(grouped[, startsWith(names(grouped), "cnpj_")])^2

# Juntando à shape_final
shape_final <- grouped |>
  dplyr::right_join(shape_final, by = "code_district") |>
  sf::st_as_sf()
  

# Removendo parte geométrica para utilizar no ACP
data <- shape_final |>
  sf::st_drop_geometry() |>
  dplyr::select(
    c(
      "code_district",
      "IRC",
      "IRE",
      "IRF",
      "IRL",
      "IRD",
      "PLP",
      "PLB",
      "PLBe",
      "IRR",
      "ICO",
      "ICB"
    )
  ) |>
  dplyr::filter(!is.na(ICO))

shape_final |>
  dplyr::rename(
     "cd_ds" = "code_district"
  ) |>
  dplyr::select(
    c(
      "cd_ds",
      "IRC",
      "IRE",
      "IRF",
      "IRL",
      "IRD",
      "PLP",
      "PLB",
      "PLBe",
      "IRR",
      "ICO",
      "ICB",
      "rpc",
      "agua_encanada",
      "esgoto",
      "banheiro",
      "energia_eletrica"
    )
  ) |>
  sf::write_sf("data/shapefinal/shapefinal.shp")


data |> write.csv("data/data.csv", row.names = FALSE)
```

# RESULTADOS

## *Análise exploratória*

As Figuras 2 à 11 mostram a distribuição geográfica dos índices de concentração e preferência por liquidez criados na seção 3.2 para os distritos de São Paulo, destacando-se os distritos centrais:

```{r, echo=FALSE}
final <- sf::read_sf("data/shapefinal/shapefinal.shp")

final2 <- final

agencias_sp <- sf::read_sf("data/agencias/agencias.shp")

agencias_sp <- agencias_sp |>
  dplyr::mutate(
    banco = ifelse(
      cnpj == "00000000", "Banco do Brasil",
      ifelse(
        cnpj == "90400888", "Santander",
        ifelse(
          cnpj %in% c("60746948", "07207996"), "Bradesco",
          ifelse(
            cnpj %in% c("60701190", "17298092"), "Itaú",
            ifelse(
              cnpj == "00360305", "Caixa Econômica Federal", "Outros"
            )
          )
        )
      )
    )
)

agencias_sp$norm_lucro <- scale(agencias_sp$`710`)
agencias_sp$padr_lucro <- (agencias_sp$`710` - min(agencias_sp$`710`)) / (max(agencias_sp$`710`) - min(agencias_sp$`710`))


cols <- c(
  "Banco do Brasil" = "#F9DD16",
  "Santander" = "#ec0000",
  "Bradesco" = "#633280",
  "Itaú" = "#f28500",
  "Caixa Econômica Federal" = "#1c60ab",
  "Outros" = "#333333"
)

palette1 <- c("#264653", "#2a9d8f", "#e9c46a", "#f4a261","#e76f51")
palette2 <- c("#8ecae6","#219ebc","#023047","#ffb703","#fb8500")
palette3 <- c("#9dbf9e", "#fcb97d", "#a84268")
```


```{r echo=FALSE, eval=FALSE}
irc_map <- ggplot2::ggplot(final2) +
  ggplot2::geom_sf(mapping = aes(fill = IRC), lwd = 0, colour = NA) +
  ggplot2::scale_fill_gradientn(
    colors = palette1,
    trans = "log1p",
    name = "Índice Regional do Crédito (IRC)",
    na.value = "grey80",
  ) +
  ggplot2::geom_sf(agencias_sp, mapping = aes(colour = banco, size = `160`)) +
  ggplot2::scale_colour_manual(
    values = scales::alpha(cols, 0.5),
    na.value = "grey80",
    name = "Banco"
  ) +
  ggplot2::scale_size_area(
    name = "Operações de crédito (R$)",
    max_size = 5
  ) +
  theme_void() +
  theme(
    text = element_text(face = "plain"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12, face = "plain"),
    legend.position = "left",
    legend.box.spacing = unit(0.5, "cm"),
    legend.spacing.y = unit(1, "cm")
  ) +
  annotation_scale(location = "bl", line_width = 0.4) +
  annotation_north_arrow(
    location = "br",
    style = north_arrow_fancy_orienteering(),
    height = unit(1, "cm"),
    width = unit(1, "cm")
  )


irc_map <-
  irc_map + geom_rect(
    xmin = -46.600000,
    ymin = -23.500000,
    xmax = -46.700000,
    ymax = -23.600000,
    fill = NA,
    colour = "black",
    size = 0.7
  )


irc_cow <- irc_map |> cowplot::ggdraw() +
  draw_plot(
    {
      irc_map +
        coord_sf(
          xlim = c(-46.700000, -46.600000),
          ylim = c(-23.600000, -23.500000),
          expand = FALSE
        ) +
        theme(legend.position = "none") +
        annotation_scale(location = "bl", line_width = 0.4)
    },
    x = 0.6,
    y = 0.1,
    width = 0.4,
    height = 0.4
  )

irc_cow

ggsave("exports/irc.pdf", plot = irc_cow, width = 5000, height = 5000, units = "px", dpi = 320)
```

É possível observar, por meio da figura \ref{fig:irc}, a alta concentração de crédito ofertado no centro histórico de São Paulo (Sé), bastante dominado pelos 5 maiores bancos do Brasil, especialmente pelo Santander, maior ofertante de crédito nessa região, em 2010. Além do centro histórico (Sé), regiões como Vila Curuçá, Jabaquara, Consolação, Santo Amaro, Bela Vista e Itaim Bibi também concentraram a oferta de crédito acima da concentração de renda. A concentração de crédito em regiões próximas dos aeroportos de Guarulhos e Congonhas (Vila Curuçá e Jabaquara) pode ser explicada pela presença de empresas e instituições financeiras nessas regiões. Esses empreendimentos costumam ter maior necessidade de crédito, o que pode justificar a concentração de crédito nessas regiões.

\fig{Índice Regional do Crédito (IRC) no município de São Paulo (2010).}{fig:irc}{exports/irc.pdf}{Elaboração própria.}

```{r echo=FALSE, eval=FALSE}

ire_map <- ggplot2::ggplot(final2) +
  ggplot2::geom_sf(mapping = aes(fill = IRE), lwd = 0, colour = NA) +
  ggplot2::scale_fill_gradientn(
    colors = palette1,
    trans = "log1p",
    name = "Índice Regional de Empréstimos (IRE)",
    na.value = "grey80",
  ) +
  ggplot2::geom_sf(agencias_sp, mapping = aes(colour = banco, size = `161`)) +
  ggplot2::scale_colour_manual(
    values = scales::alpha(cols, 0.5),
    na.value = "grey80",
    name = "Banco"
  ) +
  ggplot2::scale_size_area(
    name = "Empréstimos e desconto de títulos (R$)",
    max_size = 5
  ) +
  theme_void() +
  theme(
    text = element_text(face = "plain"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12, face = "plain"),
    legend.position = "left",
    legend.box.spacing = unit(0.5, "cm"),
    legend.spacing.y = unit(1, "cm")
  ) +
  annotation_scale(location = "bl", line_width = 0.4) +
  annotation_north_arrow(
    location = "br",
    style = north_arrow_fancy_orienteering(),
    height = unit(1, "cm"),
    width = unit(1, "cm")
  )


ire_map <-
  ire_map + geom_rect(
    xmin = -46.600000,
    ymin = -23.500000,
    xmax = -46.700000,
    ymax = -23.600000,
    fill = NA,
    colour = "black",
    size = 0.7
  )


ire_cow <- ire_map |> cowplot::ggdraw() +
  draw_plot(
    {
      ire_map +
        coord_sf(
          xlim = c(-46.700000, -46.600000),
          ylim = c(-23.600000, -23.500000),
          expand = FALSE
        ) +
        theme(legend.position = "none") +
        annotation_scale(location = "bl", line_width = 0.4)
    },
    x = 0.6,
    y = 0.1,
    width = 0.4,
    height = 0.4
  )

ggsave("exports/ire.pdf", plot = ire_cow, width = 5000, height = 5000, units = "px", dpi = 320)
```

A figura \ref{fig:ire} mostra que a concentração de empréstimos é semelhante à concentração de crédito como um todo. Isso significa que os bancos estão mais propensos a conceder empréstimos para clientes em regiões com maior renda. No entanto, há uma dispersão um pouco maior, comparada à oferta de crédito como um todo.

\fig{Índice Regional de Empréstimos (IRE) no município de São Paulo (2010).}{fig:ire}{exports/ire.pdf}{Elaboração própria.}

```{r echo=FALSE, eval=FALSE}

irf_map <- ggplot2::ggplot(final2) +
  ggplot2::geom_sf(mapping = aes(fill = IRF), lwd = 0, colour = NA) +
  ggplot2::scale_fill_gradientn(
    colors = palette1,
    trans = "log1p",
    name = "Índice Regional de Financiamentos (IRF)",
    na.value = "grey80",
  ) +
  ggplot2::geom_sf(agencias_sp, mapping = aes(colour = banco, size = `162`)) +
  ggplot2::scale_colour_manual(
    values = scales::alpha(cols, 0.5),
    na.value = "grey80",
    name = "Banco"
  ) +
  ggplot2::scale_size_area(
    name = "Financiamentos (R$)",
    max_size = 5
  ) +
  theme_void() +
  theme(
    text = element_text(face = "plain"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12, face = "plain"),
    legend.position = "left",
    legend.box.spacing = unit(0.5, "cm"),
    legend.spacing.y = unit(1, "cm")
  ) +
  annotation_scale(location = "bl", line_width = 0.4) +
  annotation_north_arrow(
    location = "br",
    style = north_arrow_fancy_orienteering(),
    height = unit(1, "cm"),
    width = unit(1, "cm")
  )


irf_map <-
  irf_map + geom_rect(
    xmin = -46.600000,
    ymin = -23.500000,
    xmax = -46.700000,
    ymax = -23.600000,
    fill = NA,
    colour = "black",
    size = 0.7
  )


irf_cow <- irf_map |> cowplot::ggdraw() +
  draw_plot(
    {
      irf_map +
        coord_sf(
          xlim = c(-46.700000, -46.600000),
          ylim = c(-23.600000, -23.500000),
          expand = FALSE
        ) +
        theme(legend.position = "none") +
        annotation_scale(location = "bl", line_width = 0.4)
    },
    x = 0.6,
    y = 0.1,
    width = 0.4,
    height = 0.4
  )

ggsave("exports/irf.pdf", plot = irf_cow, width = 5000, height = 5000, units = "px", dpi = 320)
```

A figura \ref{fig:irf} mostra um padrão ainda mais nítido de concentração financeira, em que pouquíssimos distritos contam com agências que fazem financiamentos. Distritos como Brasilândia, Cidade Tiradentes, Pedreira, Jardim Helena, Anhanguera e Marsilac não têm 1 centavo em financiamento no momento da análise. As regiões centrais, por sua vez, concentram uma oferta de financiamento muito superior ao nível de renda da região.

\fig{Índice Regional de Financiamentos (IRF) no município de São Paulo (2010).}{fig:irf}{exports/irf.pdf}{Elaboração própria.}

```{r echo=FALSE, eval=FALSE}

ird_map <- ggplot2::ggplot(final2) +
  ggplot2::geom_sf(mapping = aes(fill = IRD), lwd = 0, colour = NA) +
  ggplot2::scale_fill_gradientn(
    colors = palette1,
    trans = "log1p",
    name = "Índice Regional de Depósitos (IRD)",
    na.value = "grey80",
  ) +
  ggplot2::geom_sf(agencias_sp, mapping = aes(colour = banco, size = `401_402`)) +
  ggplot2::scale_colour_manual(
    values = scales::alpha(cols, 0.5),
    na.value = "grey80",
    name = "Banco"
  ) +
  ggplot2::scale_size_area(
    name = "Depósitos (R$)",
    max_size = 5
  ) +
  theme_void() +
  theme(
    text = element_text(face = "plain"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12, face = "plain"),
    legend.position = "left",
    legend.box.spacing = unit(0.5, "cm"),
    legend.spacing.y = unit(1, "cm")
  ) +
  annotation_scale(location = "bl", line_width = 0.4) +
  annotation_north_arrow(
    location = "br",
    style = north_arrow_fancy_orienteering(),
    height = unit(1, "cm"),
    width = unit(1, "cm")
  )

ird_map

ird_map <-
  ird_map + geom_rect(
    xmin = -46.600000,
    ymin = -23.500000,
    xmax = -46.700000,
    ymax = -23.600000,
    fill = NA,
    colour = "black",
    size = 0.7
  )


ird_cow <- ird_map |> cowplot::ggdraw() +
  draw_plot(
    {
      ird_map +
        coord_sf(
          xlim = c(-46.700000, -46.600000),
          ylim = c(-23.600000, -23.500000),
          expand = FALSE
        ) +
        theme(legend.position = "none") +
        annotation_scale(location = "bl", line_width = 0.4)
    },
    x = 0.6,
    y = 0.1,
    width = 0.4,
    height = 0.4
  )

ggsave("exports/ird.pdf", plot = ird_cow, width = 5000, height = 5000, units = "px", dpi = 320)
```

O Índice Regional de Depósitos, presente na figura \ref{fig:ird}, mostra que os depósitos estão mais bem distribuídos do que o crédito. Isso pode ser um indício de que as agências sejam eficientes em captar depósitos em todo espaço geográfico, diferentemente do que acontece na oferta de crédito.

Existem algumas possíveis explicações para esse resultado:

- Os depósitos são mais fáceis de captar. Os depósitos podem ser captados por meio de diferentes canais, como caixas eletrônicos, internet banking e atendimento presencial.
- Os depósitos são mais necessários para as agências. Os depósitos são utilizados pelos bancos para financiar a oferta de crédito.

A concentração um pouco maior nos regiões centrais pode ser explicada por alguns fatores, como:

- A maior renda e população nas regiões centrais.
- A maior concentração de empresas e instituições nas regiões centrais.
- A maior presença de agências bancárias nas regiões centrais.

\fig{Índice Regional de Depósitos (IRD) no município de São Paulo (2010).}{fig:ird}{exports/ird.pdf}{Elaboração própria.}

```{r echo=FALSE, eval=FALSE}

irl_map <- ggplot2::ggplot(final2) +
  ggplot2::geom_sf(mapping = aes(fill = IRL), lwd = 0, colour = NA) +
  ggplot2::scale_fill_gradientn(
    colors = palette1,
    name = "Índice Regional de Lucros (IRL)",
    na.value = "grey80",
    oob = scales::squish,
    limits = c(-10, 2),
    guide = "legend",
    breaks = c(-10, -6, -2, 0, 2)
  ) +
  ggplot2::geom_sf(agencias_sp, mapping = aes(colour = banco)) +
  ggplot2::scale_colour_manual(
    values = scales::alpha(cols, 0.5),
    na.value = "grey80",
    name = "Banco"
  ) +
  theme_void() +
  theme(
    text = element_text(face = "plain"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12, face = "plain"),
    legend.position = "left",
    legend.box.spacing = unit(0.5, "cm"),
    legend.spacing.y = unit(1, "cm")
  ) +
  annotation_scale(location = "bl", line_width = 0.4) +
  annotation_north_arrow(
    location = "br",
    style = north_arrow_fancy_orienteering(),
    height = unit(1, "cm"),
    width = unit(1, "cm")
  )

irl_map

irl_map <-
  irl_map + geom_rect(
    xmin = -46.600000,
    ymin = -23.500000,
    xmax = -46.700000,
    ymax = -23.600000,
    fill = NA,
    colour = "black",
    size = 0.7
  )


irl_cow <- irl_map |> cowplot::ggdraw() +
  draw_plot(
    {
      irl_map +
        coord_sf(
          xlim = c(-46.700000, -46.600000),
          ylim = c(-23.600000, -23.500000),
          expand = FALSE
        ) +
        theme(legend.position = "none") +
        annotation_scale(location = "bl", line_width = 0.4)
    },
    x = 0.6,
    y = 0.1,
    width = 0.4,
    height = 0.4
  )

ggsave("exports/irl.pdf", plot = irl_cow, width = 5000, height = 5000, units = "px", dpi = 320)
```


```{r echo=FALSE, eval=FALSE}

irr_map <- ggplot2::ggplot(final2) +
  ggplot2::geom_sf(mapping = aes(fill = IRR), lwd = 0, colour = NA) +
  ggplot2::scale_fill_gradientn(
    colors = palette1,
    trans = "log1p",
    name = "Índice Regional de Risco (IRR)",
    na.value = "grey80",
    guide = "legend",
    breaks = c(0, 5, 10, 100, 400, 500)
  ) +
  ggplot2::geom_sf(agencias_sp, mapping = aes(colour = banco, size = abs(`174`))) +
  ggplot2::scale_colour_manual(
    values = scales::alpha(cols, 0.5),
    na.value = "grey80",
    name = "Banco"
  ) +
  ggplot2::scale_size_area(
    name = "Provisão de crédito (R$)",
    max_size = 5,
    na.value = 0
  ) +
  theme_void() +
  theme(
    text = element_text(face = "plain"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 10, face = "plain"),
    legend.position = "left",
    legend.box.spacing = unit(0.5, "cm"),
    legend.spacing.y = unit(1, "cm")
  ) +
  annotation_scale(location = "bl", line_width = 0.4) +
  annotation_north_arrow(
    location = "br",
    style = north_arrow_fancy_orienteering(),
    height = unit(1, "cm"),
    width = unit(1, "cm")
  )


irr_map <-
  irr_map + geom_rect(
    xmin = -46.600000,
    ymin = -23.500000,
    xmax = -46.700000,
    ymax = -23.600000,
    fill = NA,
    colour = "black",
    size = 0.7
  )


irr_cow <- irr_map |> cowplot::ggdraw() +
  draw_plot(
    {
      irr_map +
        coord_sf(
          xlim = c(-46.700000, -46.600000),
          ylim = c(-23.600000, -23.500000),
          expand = FALSE
        ) +
        theme(legend.position = "none") +
        annotation_scale(location = "bl", line_width = 0.4)
    },
    x = 0.6,
    y = 0.1,
    width = 0.4,
    height = 0.4
  )

ggsave("exports/irr.pdf", plot = irr_cow, width = 5000, height = 5000, units = "px", dpi = 320)
```

O Índice Regional de Risco da figura \ref{fig:irr} nos dá indício de como os bancos enxergam centro e periferia. As regiões periféricas no entorno do centro têm agências que provisionam muito mais crédito, em relação à renda da região, para cobrir possíveis inadimplências. Essa percepção de risco dos bancos pode ser determinante na oferta de crédito, pois os bancos estão mais propensos a conceder crédito para clientes em regiões consideradas de menor risco, como o centro da cidade. Essa dinâmica pode ter um impacto negativo no desenvolvimento econômico das regiões periféricas. A falta de acesso ao crédito pode dificultar a geração de renda e a criação de empregos nessas regiões.

\fig{Índice Regional de Risco (IRR) no município de São Paulo (2010).}{fig:irr}{exports/irr.pdf}{Elaboração própria.}

A observação do resultado das agências e sua distribuição no espaço pelo IRL da figura \ref{fig:irl}, confirma a percepção de risco dos bancos em relação às regiões periféricas. As agências localizadas nessas regiões, apesar de terem um índice de risco mais alto, apresentaram resultados financeiros melhores do que as agências localizadas em regiões centrais. Esse resultado pode ser explicado por duas hipóteses:

- Operações mais lucrativas: as agências localizadas nas regiões periféricas podem ter realizado operações mais lucrativas, como empréstimos pessoais e cheque especial. Essas operações costumam ter taxas de juros mais altas, o que pode compensar o risco de inadimplência.

- Taxas diferentes: as agências localizadas nas regiões periféricas podem ter operado com taxas diferentes em cada região. Essas taxas podem ser mais altas nas regiões periféricas, o que também pode compensar o risco de inadimplência.

\fig{Índice Regional de Lucros (IRL) no município de São Paulo (2010).}{fig:irl}{exports/irl.pdf}{Elaboração própria.}

```{r echo=FALSE, eval=FALSE}

plp_map <- ggplot2::ggplot(final2) +
  ggplot2::geom_sf(mapping = aes(fill = PLP), lwd = 0, colour = NA) +
  ggplot2::scale_fill_gradientn(
    colors = palette1,
    name = "Preferência por liquidez do público (PLP)",
    na.value = "grey80"
  ) +
  ggplot2::geom_sf(agencias_sp, mapping = aes(colour = banco, size = abs(`420`))) +
  ggplot2::scale_colour_manual(
    values = scales::alpha(cols, 0.5),
    na.value = "grey80",
    name = "Banco"
  ) +
  ggplot2::scale_size_area(
    name = "Poupança (R$)",
    max_size = 5,
    na.value = 0
  ) +
  theme_void() +
  theme(
    text = element_text(face = "plain"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 10, face = "plain"),
    legend.position = "left",
    legend.box.spacing = unit(0.5, "cm"),
    legend.spacing.y = unit(1, "cm")
  ) +
  annotation_scale(location = "bl", line_width = 0.4) +
  annotation_north_arrow(
    location = "br",
    style = north_arrow_fancy_orienteering(),
    height = unit(1, "cm"),
    width = unit(1, "cm")
  )


plp_map <-
  plp_map + geom_rect(
    xmin = -46.600000,
    ymin = -23.500000,
    xmax = -46.700000,
    ymax = -23.600000,
    fill = NA,
    colour = "black",
    size = 0.7
  )


plp_cow <- plp_map |> cowplot::ggdraw() +
  draw_plot(
    {
      plp_map +
        coord_sf(
          xlim = c(-46.700000, -46.600000),
          ylim = c(-23.600000, -23.500000),
          expand = FALSE
        ) +
        theme(legend.position = "none") +
        annotation_scale(location = "bl", line_width = 0.4)
    },
    x = 0.6,
    y = 0.1,
    width = 0.4,
    height = 0.4
  )

ggsave("exports/plp.pdf", plot = plp_cow, width = 5000, height = 5000, units = "px", dpi = 320)
```

Como era esperado pela literatura [@dow82;@chick88;@crocco2006], as regiões periféricas apresentam maior preferência por liquidez (Figura \ref{fig:plp}). Isso pode ser explicado por alguns fatores, como:

- A maior incerteza financeira: as pessoas que moram em regiões periféricas tendem a ter renda menor e a enfrentar mais incerteza financeira. Isso pode levar a uma maior preferência por liquidez, para garantir que haja dinheiro disponível para despesas inesperadas.

- A menor oferta de crédito: a oferta de crédito é mais limitada nas regiões periféricas. Isso pode levar as pessoas a manter mais dinheiro em conta corrente ou em aplicações de liquidez imediata, para evitar a necessidade de recorrer ao crédito.

- A menor penetração de serviços bancários: os serviços bancários são menos acessíveis nas regiões periféricas. Isso pode levar as pessoas a manter mais dinheiro em conta corrente ou em aplicações de liquidez imediata, para evitar a necessidade de se deslocar para agências bancárias.

\fig{Preferência por liquidez do público (PLP) no município de São Paulo (2010).}{fig:plp}{exports/plp.pdf}{Elaboração própria.}

```{r echo=FALSE, eval=FALSE}

plb_map <- ggplot2::ggplot(final2) +
  ggplot2::geom_sf(mapping = aes(fill = PLB), lwd = 0, colour = NA) +
  ggplot2::scale_fill_gradientn(
    colors = palette1,
    name = "Preferência por liquidez dos bancos (PLB)",
    na.value = "grey80",
    trans = "log1p"
  ) +
  ggplot2::geom_sf(agencias_sp, mapping = aes(colour = banco, size = `160`)) +
  ggplot2::scale_colour_manual(
    values = scales::alpha(cols, 0.5),
    na.value = "grey80",
    name = "Banco"
  ) +
  ggplot2::scale_size_area(
    name = "Operações de crédito (R$)",
    max_size = 5,
    na.value = 0
  ) +
  theme_void() +
  theme(
    text = element_text(face = "plain"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 10, face = "plain"),
    legend.position = "left",
    legend.box.spacing = unit(0.5, "cm"),
    legend.spacing.y = unit(1, "cm")
  ) +
  annotation_scale(location = "bl", line_width = 0.4) +
  annotation_north_arrow(
    location = "br",
    style = north_arrow_fancy_orienteering(),
    height = unit(1, "cm"),
    width = unit(1, "cm")
  )


plb_map <-
  plb_map + geom_rect(
    xmin = -46.600000,
    ymin = -23.500000,
    xmax = -46.700000,
    ymax = -23.600000,
    fill = NA,
    colour = "black",
    size = 0.7
  )


plb_cow <- plb_map |> cowplot::ggdraw() +
  draw_plot(
    {
      plb_map +
        coord_sf(
          xlim = c(-46.700000, -46.600000),
          ylim = c(-23.600000, -23.500000),
          expand = FALSE
        ) +
        theme(legend.position = "none") +
        annotation_scale(location = "bl", line_width = 0.4)
    },
    x = 0.6,
    y = 0.1,
    width = 0.4,
    height = 0.4
  )

ggsave("exports/plb.pdf", plot = plb_cow, width = 5000, height = 5000, units = "px", dpi = 320)
```

Assim como o PLP, o PLB também se mostrou maior nas regiões periféricas em comparação com as regiões centrais (Figura \ref{fig:plb}), indo de encontro com os resultados de Crocco *et al*. [-@crocco2006]. Isso significa que as agências no centro da cidade têm uma menor propensão a manter reservas em dinheiro ou ativos líquidos, como títulos do governo ou depósitos interbancários.

Existem várias explicações possíveis para esse fenômeno. Uma explicação é que as agências no centro da cidade têm acesso a uma maior diversidade de clientes e de fontes de financiamento. Isso lhes permite ser mais seletivos em suas decisões de empréstimo e, portanto, ter menos necessidade de manter reservas líquidas para atender às demandas de retirada dos clientes [@quaresma].

Outra explicação é que as agências no centro da cidade estão sujeitos a um menor risco de liquidez. Isso ocorre porque eles estão localizados em áreas com maior densidade populacional e econômica, o que torna mais fácil para eles obterem financiamento de emergência [@drehmann].

Independentemente da explicação, o PLB menor das agências no centro da cidade tem implicações importantes para a política monetária. Isso ocorre porque a PLB é um fator que determina a quantidade de moeda que as agências estão dispostas a emprestar. Quando o PLB é menor, as agências estão dispostas a emprestar mais dinheiro, o que pode ajudar a estimular o crescimento econômico, dentro de uma perspectiva pós-keynesiana.

\fig{Preferência por liquidez dos bancos (PLB) no município de São Paulo (2010).}{fig:plb}{exports/plb.pdf}{Elaboração própria.}

```{r echo=FALSE, eval=FALSE}

plbe_map <- ggplot2::ggplot(final2) +
  ggplot2::geom_sf(mapping = aes(fill = PLBe), lwd = 0, colour = NA) +
  ggplot2::scale_fill_gradientn(
    colors = palette1,
    name = "Preferência por liquidez dos bancos - endógena (PLBe)",
    na.value = "grey80",
    trans = "log1p"
  ) +
  ggplot2::geom_sf(agencias_sp, mapping = aes(colour = banco, size = `399`)) +
  ggplot2::scale_colour_manual(
    values = scales::alpha(cols, 0.5),
    na.value = "grey80",
    name = "Banco"
  ) +
  ggplot2::scale_size_area(
    name = "Ativo (R$)",
    max_size = 5,
    na.value = 0
  ) +
  theme_void() +
  theme(
    text = element_text(face = "plain"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 10, face = "plain"),
    legend.position = "left",
    legend.box.spacing = unit(0.5, "cm"),
    legend.spacing.y = unit(1, "cm")
  ) +
  annotation_scale(location = "bl", line_width = 0.4) +
  annotation_north_arrow(
    location = "br",
    style = north_arrow_fancy_orienteering(),
    height = unit(1, "cm"),
    width = unit(1, "cm")
  )


plbe_map <-
  plbe_map + geom_rect(
    xmin = -46.600000,
    ymin = -23.500000,
    xmax = -46.700000,
    ymax = -23.600000,
    fill = NA,
    colour = "black",
    size = 0.7
  )


plbe_cow <- plbe_map |> cowplot::ggdraw() +
  draw_plot(
    {
      plbe_map +
        coord_sf(
          xlim = c(-46.700000, -46.600000),
          ylim = c(-23.600000, -23.500000),
          expand = FALSE
        ) +
        theme(legend.position = "none") +
        annotation_scale(location = "bl", line_width = 0.4)
    },
    x = 0.6,
    y = 0.1,
    width = 0.4,
    height = 0.4
  )

ggsave("exports/plbe.pdf", plot = plbe_cow, width = 5700, height = 5000, units = "px", dpi = 320)
```

As diferenças na Preferência por liquidez dos bancos entre as regiões ficaram ainda mais claras quando se olha para o PLBe da figura \ref{fig:plbe}. Como esse indicador isola a ação do público (depósitos) e considera apenas variáveis endógenas para a agência, vemos que de fato há maior preferêcia por liquidez nas regiões periféricas por parte das agências, contrastando com a baixa preferência por liquidez nas regiões centrais.

Esse comportamento da agência em manter ativos mais líquidos na periferia pode estar ligado à maior incerteza econômica vivida nas regiões periféricas, o que também vai de encontro com a literatura pós-keynesiana apresentada [@dow82; @chick88; @crocco2006].

\fig{Preferência por liquidez dos bancos - endógena (PLBe) no município de São Paulo (2010).}{fig:plbe}{exports/plbe.pdf}{Elaboração própria.}

```{r echo=FALSE, eval=FALSE}

ico_map <- ggplot2::ggplot(final2) +
  ggplot2::geom_sf(mapping = aes(fill = ICO), lwd = 0, colour = NA) +
  ggplot2::scale_fill_gradientn(
    colors = palette1,
    name = "Índice de Concentração de Operações (ICO)",
    na.value = "grey80",
  ) +
  ggplot2::geom_sf(agencias_sp, mapping = aes(colour = banco, size = `160`)) +
  ggplot2::scale_colour_manual(
    values = scales::alpha(cols, 0.5),
    na.value = "grey80",
    name = "Banco"
  ) +
  ggplot2::scale_size_area(
    name = "Operações de crédito (R$)",
    max_size = 5,
    na.value = 0
  ) +
  theme_void() +
  theme(
    text = element_text(face = "plain"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 10, face = "plain"),
    legend.position = "left",
    legend.box.spacing = unit(0.5, "cm"),
    legend.spacing.y = unit(1, "cm")
  ) +
  annotation_scale(location = "bl", line_width = 0.4) +
  annotation_north_arrow(
    location = "br",
    style = north_arrow_fancy_orienteering(),
    height = unit(1, "cm"),
    width = unit(1, "cm")
  )


ico_map <-
  ico_map + geom_rect(
    xmin = -46.600000,
    ymin = -23.500000,
    xmax = -46.700000,
    ymax = -23.600000,
    fill = NA,
    colour = "black",
    size = 0.7
  )


ico_cow <- ico_map |> cowplot::ggdraw() +
  draw_plot(
    {
      ico_map +
        coord_sf(
          xlim = c(-46.700000, -46.600000),
          ylim = c(-23.600000, -23.500000),
          expand = FALSE
        ) +
        theme(legend.position = "none") +
        annotation_scale(location = "bl", line_width = 0.4)
    },
    x = 0.6,
    y = 0.1,
    width = 0.4,
    height = 0.4
  )

ggsave("exports/ico.pdf", plot = ico_cow, width = 5200, height = 5000, units = "px", dpi = 320)
```

O Índice de Concentração de Operações (ICO), presente na figura \ref{fig:ico}, mostra como há distritos com baixíssima diversidade de operações, localizados principalmente no extremo sul (Parelheiros, Grajaú e Pedreira) e extremo leste paulista (São Rafael, São Mateus, Iguatemi, Cidade Tiradentes, José Bonifácio, entre outros). Nessas regiões as agências praticamente só oferecem empréstimos pessoais em 2010, zero financiamento ou operações de longo prazo. Vale lembrar o contexto histórico dessas regiões, visto que o extremo sul e o extremo leste de São Paulo são regiões historicamente marginalizadas, com altos índices de pobreza e desemprego.

A grande questão é se pobreza e desemprego fizeram com que as agências não oferecessem crédito diversificado nessas regiões, ou, se a falta de crédito diversificado fez com que essas regiões enfrentassem pobreza e desemprego.

Independentemente da resposta, fica clara a grande diferença entre centro e periferia no que tange ao número de operações realizadas nas agências: As agências centrais oferecem todo tipo de crédito, enquanto agências periféricas oferecem pouquíssimas opções.

\fig{Índice de Concentração de Operações (ICO) no município de São Paulo (2010).}{fig:ico}{exports/ico.pdf}{Elaboração própria.}

```{r echo=FALSE, eval=FALSE}

icb_map <- ggplot2::ggplot(final2) +
  ggplot2::geom_sf(mapping = aes(fill = ICB), lwd = 0, colour = NA) +
  ggplot2::scale_fill_gradientn(
    colors = palette1,
    name = "Índice de Concentração Bancária (ICB)",
    na.value = "grey80",
  ) +
  ggplot2::geom_sf(agencias_sp, mapping = aes(colour = banco, size = `160`)) +
  ggplot2::scale_colour_manual(
    values = scales::alpha(cols, 0.5),
    na.value = "grey80",
    name = "Banco"
  ) +
  ggplot2::scale_size_area(
    name = "Operações de crédito (R$)",
    max_size = 5,
    na.value = 0
  ) +
  theme_void() +
  theme(
    text = element_text(face = "plain"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 10, face = "plain"),
    legend.position = "left",
    legend.box.spacing = unit(0.5, "cm"),
    legend.spacing.y = unit(1, "cm")
  ) +
  annotation_scale(location = "bl", line_width = 0.4) +
  annotation_north_arrow(
    location = "br",
    style = north_arrow_fancy_orienteering(),
    height = unit(1, "cm"),
    width = unit(1, "cm")
  )

icb_map

icb_map <-
  icb_map + geom_rect(
    xmin = -46.600000,
    ymin = -23.500000,
    xmax = -46.700000,
    ymax = -23.600000,
    fill = NA,
    colour = "black",
    size = 0.7
  )


icb_cow <- icb_map |> cowplot::ggdraw() +
  draw_plot(
    {
      icb_map +
        coord_sf(
          xlim = c(-46.700000, -46.600000),
          ylim = c(-23.600000, -23.500000),
          expand = FALSE
        ) +
        theme(legend.position = "none") +
        annotation_scale(location = "bl", line_width = 0.4)
    },
    x = 0.6,
    y = 0.1,
    width = 0.4,
    height = 0.4
  )

ggsave("exports/icb.pdf", plot = icb_cow, width = 5200, height = 5000, units = "px", dpi = 320)
```

O Índice de Concentração Bancária (figura \ref{fig:icb}) ficou alto em distritos com poucas agências, como os da periferia, mas também ficou elevado em alguns distritos com grande volume de agências, como Sé, República e Consolação (Centro). Mesmo onde há maior diversificação, o ICB é próximo de $0.2$, o que significa que todo volume de operações de crédito é dividido entre aproximadamente 5 bancos, o que condiz com o conhecido domínio dos 5 grandes bancos no Brasil (Santander, Bradesco, Itaú, Banco do Brasil e Caixa).

\fig{Índice de Concentração Bancária (ICB) no município de São Paulo (2010).}{fig:icb}{exports/icb.pdf}{Elaboração própria.}

\newpage

## *Resultados da ACP*

A @fig-cor-heatmap demonstra a correlação entre as variáveis criadas, fundamental para aplicação do método ACP.

```{r echo=FALSE, results='asis'}
#| label: fig-cor-heatmap
#| fig-cap: "Mapa de calor da matriz de correlação."

data = read.csv("data/data.csv")

data[, -1] |> cor() |> heatmap()
```

A @tbl-acp contém a variância explicada por cada componente resultante da ACP.

```{r, echo=FALSE, results='asis'}
#| label: tbl-acp
#| tbl-cap: "Total da Variância Explicada dos 11 componentes."

acp <- data[, -1] |>
  princomp(cor = TRUE)

dplyr::tibble(matrix(seq(1:11), nrow = 11)) %>% 
  dplyr::rename(Componentes = 1) %>% 
  dplyr::mutate(`Individual (%)` = round((100*((as.numeric(acp$sdev))^2)/sum((as.numeric(acp$sdev))^2)),2)) %>% 
  dplyr::mutate(`Acumulada (%)` = cumsum(`Individual (%)`)) %>% 
  stargazer::stargazer(
    header=FALSE,
    type='latex',
    summary = FALSE,
    rownames = FALSE,
    style = "aer",
    notes = "Fonte: Elaboração própria.",
    digits = 2
  )

```

\newpage

Com auxílio do critério de Kaiser e do modelo Broken-Stick (Figura \ref{fig-acp}), foram escolhidos 2 componentes para serem analisados, pois já concentram 71,7% da variância total e condensam múltiplas dimensões para uma análise bidimensional.

```{r echo=FALSE, result='asis'}
#| label: fig-acp
#| fig-cap: "Autovalores e modelo Broken-Stick."

plot.BS = function(ACP) {
  ev = ((ACP$sdev)^2)/sum(((ACP$sdev)^2))
  # Modelo Broken stick  (MacArthur 1957)
  n = length(ev)
  bsm = data.frame(j=seq(1:n), p=0)
  bsm$p[1] = 1/n
  for (i in 2:n) bsm$p[i] = bsm$p[i-1] + (1/(n + 1 - i))
  bsm$p = 100*bsm$p/n

  # Defina a família de fontes como "serif" no ambiente gráfico global
  par(family = "serif", cex = 1)

  # Plotar os Autovalores e o % de variacao
  op = par(mfrow=c(2,1), omi=c(0.2,0.2,0.2,0.2), mar=c(2,2 , 2, 2))
  barplot(ev, main="Autovalores", col="#9dbf9e", las=0.5, cex.main = 1)
  abline(h=mean(ev), col="#a84268")
  legend("topright", "Autovalor Medio", lwd=1, col=2, bty="n")
  barplot(t(cbind(100*ev/sum(ev), bsm$p[n:1])), beside=TRUE, 
          main="% Variância", col=c("#9dbf9e",2), las=0.5, cex.main = 1)
  legend("topright", c("% Autovalor", "Modelo 'Broken-Stick'"), 
         pch=10, col=c("#9dbf9e",2), bty="n")
  par(op)
}

plot.BS(acp)
```

Como pode-se observar na @tbl-loadings, o primeiro componente se mostrou positivamente e bastante relacionado com os índices IRC, IRE, IRF, IRD, IRR e IRL. Logo, tal componente foi nomeado Índice de Concentração Financeira (ICF), pois é capaz de mensurar quanto cada distrito concentra em volume de empréstimos, financiamentos e depósitos em relação à renda. O segundo componente, no entanto, deu maior peso ao ICO, ICB, PLP, PLB, PLBe, que se relacionam de forma negativa com o componente, o que siginifica que maior preferência por liquidez (PLP, PLB e PLBe) e menor diversidade bancária e de operações de crédito (ICB e ICO) geram um componente menor, logo, tal componente pode ser nomeado Índice de Qualidade Financeira (IQF).


```{r, echo=FALSE, results='asis'}
#| label: tbl-loadings
#| tbl-cap: "Cargas dos componentes analisados."

components <- row.names(acp$loadings[,c(1, 2)])

acp$scores[, 2] <- - acp$scores[, 2]
acp$loadings[, 2] <- - acp$loadings[, 2]

acp$loadings[,c(1, 2)] %>%
  round(4) %>%
  dplyr::as_tibble() %>%
  dplyr::mutate(
    `Variável` = row.names(acp$loadings[,c(1, 2)])
  ) %>%
  dplyr::select(
    c("Variável", "Comp.1", "Comp.2")
  ) %>%
  stargazer::stargazer(
    header=FALSE,
    type='latex',
    summary = FALSE,
    rownames = FALSE,
    style = "aer",
    notes = "Fonte: Elaboração própria."
  )
```

A @fig-scores mostra a distribuição dos distritos paulistas segundo os componentes ICF e IQF.

```{r, echo=FALSE, message=FALSE, result='asis'}
#| label: fig-scores
#| fig-cap: "Gráfico de dispersão dos distritos de São Paulo (2010), de acordo com os scores da ACP."


br_bairros <- geobr::read_neighborhood(2010, showProgress = FALSE, simplified = FALSE)
# distritos da cidade de São Paulo
sp_bairros <- br_bairros |>
  dplyr::filter(code_muni == "3550308") |>
  dplyr::mutate(code_district = as.character(code_district))

scores <- data.frame(
    comp1 = acp$scores[, 1],
    comp2 = acp$scores[, 2],
    code_district = as.character(data$code_district)
)

scores <- scores |>
  dplyr::left_join(sp_bairros, by="code_district") |>
  dplyr::select(c(
    "code_district",
    "name_district",
    "comp1",
    "comp2"
  ))

scores <- scores[order(-scores$comp1), ]
top3_comp1 <- scores$name_district[1:3]

scores <- scores[order(-scores$comp2), ]
top3_comp2 <- scores$name_district[1:5]

scores <- scores[order(scores$comp1), ]
low3_comp1 <- scores$name_district[1:3]

scores <- scores[order(scores$comp2), ]
low3_comp2 <- scores$name_district[1:3]

library(ggrepel)

palette1 <- c("#264653", "#2a9d8f", "#e9c46a", "#f4a261","#e76f51") 

ggplot2::ggplot(scores,  aes(x = comp1, y = comp2, label = name_district)) +
  ggplot2::geom_point(mapping = aes(colour = comp1+comp2)) +
  ggplot2::scale_color_gradientn(
    colors = palette1,
    name = "ICF + IQF",
  ) +
  ggplot2::labs(
    x = "Índice de Centralidade Financeira (ICF)",
    y = "Índice de Qualidade Financeira (IQF)",
    title = "Scores da ACP - distritos São Paulo (2010)."
  ) +
  ggrepel::geom_text_repel(
    data = subset(
      scores,
      name_district %in% c(top3_comp1, top3_comp2, low3_comp1, low3_comp2)
    ),
    box.padding = 0.5,
    size = 3
  ) +
  ggplot2::geom_vline(xintercept = 0, linetype = "dashed", color = "gray30") +
  ggplot2::geom_hline(yintercept = 0, linetype = "dashed", color = "gray30") +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    text = ggplot2::element_text(family = "serif", size = 10, face = "bold"),
    legend.text = ggplot2::element_text(family = "serif", size = 10, face = "plain")
  )
```

É possível observar que o centro histórico de São Paulo (Sé) concentra quase toda atividade financeira do município, sendo portanto, o maior centro financeiro do município e, provavelmente, da América Latina, em termos quantitativos. Distritos à direita do eixo vertical também concentram oferta de crédito além de sua própria renda, mesmo estando muito abaixo do distrito Sé, que é um *outlier* em termos de centralidade. Nota-se que no primeiro quadrante, há distritos nobres e historicamente ricos da capital paulista: Jardim Paulista, Itaim Bibi, Consolação e Bela Vista; e os distritos com alta atividade comercial: Santo Amaro e Jabaquara. Em termos financeiros, apresentam maior índice de qualidade, dada a diversidade do crédito ofertado, maior competição bancária e menor preferência por liquidez. Isso nos dá indícios de que os pressupostos pós-keynesianos podem ser verificados em São Paulo, e que, de fato, numa economia monetária de produção, a oferta de moeda numa região pode determinar seu desenvolvimento. As figuras abaixo mostram a distribuição geográfica dos indicadores ICF e IQF:


```{r, echo=FALSE}
final2 <- final2 |>
  dplyr::left_join(scores, by = c("cd_ds" = "code_district"))
```

```{r, echo=FALSE, eval=FALSE}

icf_map <- ggplot2::ggplot(final2) +
  ggplot2::geom_sf(mapping = aes(fill = comp1), lwd = 0, colour = NA) +
  ggplot2::scale_fill_gradientn(
    colors = palette1,
    name = "Índice de Centralidade Financeira (ICF)",
    na.value = "grey80",
    oob = scales::squish,
    guide = "legend"
  ) +
  ggplot2::geom_sf(agencias_sp, mapping = aes(colour = banco, size = `160`)) +
  ggplot2::scale_colour_manual(
    values = scales::alpha(cols, 0.5),
    na.value = "grey80",
    name = "Banco"
  ) +
  ggplot2::scale_size_area(
    name = "Operações de crédito (R$)",
    max_size = 5,
    na.value = 0
  ) +
  theme_void() +
  theme(
    text = element_text(face = "plain"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 10, face = "plain"),
    legend.position = "left",
    legend.box.spacing = unit(0.5, "cm"),
    legend.spacing.y = unit(1, "cm")
  ) +
  annotation_scale(location = "bl", line_width = 0.4) +
  annotation_north_arrow(
    location = "br",
    style = north_arrow_fancy_orienteering(),
    height = unit(1, "cm"),
    width = unit(1, "cm")
  )


icf_map <-
  icf_map + geom_rect(
    xmin = -46.600000,
    ymin = -23.500000,
    xmax = -46.700000,
    ymax = -23.600000,
    fill = NA,
    colour = "black",
    size = 0.7
  )


icf_cow <- icf_map |> cowplot::ggdraw() +
  draw_plot(
    {
      icf_map +
        coord_sf(
          xlim = c(-46.700000, -46.600000),
          ylim = c(-23.600000, -23.500000),
          expand = FALSE
        ) +
        theme(legend.position = "none") +
        annotation_scale(location = "bl", line_width = 0.4)
    },
    x = 0.6,
    y = 0.1,
    width = 0.4,
    height = 0.4
  )

ggsave("exports/icf.pdf", plot = icf_cow, width = 5000, height = 5000, units = "px", dpi = 320)
```

\fig{Índice de Centralidade Financeira (ICF) no município de São Paulo (2010).}{fig:icf}{exports/icf.pdf}{Elaboração própria.}

```{r, echo=FALSE, eval=FALSE}

iqf_map <- ggplot2::ggplot(final2) +
  ggplot2::geom_sf(mapping = aes(fill = comp2), lwd = 0, colour = NA) +
  ggplot2::scale_fill_gradientn(
    colors = palette1,
    name = "Índice de Qualidade Financeira (IQF)",
    na.value = "grey80",
    guide = "legend",
    limits = c(-1, 5),
    oob = scales::squish,
  ) +
  ggplot2::geom_sf(agencias_sp, mapping = aes(colour = banco, size = `162`)) +
  ggplot2::scale_colour_manual(
    values = scales::alpha(cols, 0.5),
    na.value = "grey80",
    name = "Banco"
  ) +
  ggplot2::scale_size_area(
    name = "Financiamentos (R$)",
    max_size = 5,
    na.value = 0
  ) +
  theme_void() +
  theme(
    text = element_text(face = "plain"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 10, face = "plain"),
    legend.position = "left",
    legend.box.spacing = unit(0.5, "cm"),
    legend.spacing.y = unit(1, "cm")
  ) +
  annotation_scale(location = "bl", line_width = 0.4) +
  annotation_north_arrow(
    location = "br",
    style = north_arrow_fancy_orienteering(),
    height = unit(1, "cm"),
    width = unit(1, "cm")
  )


iqf_map <-
  iqf_map + geom_rect(
    xmin = -46.600000,
    ymin = -23.500000,
    xmax = -46.700000,
    ymax = -23.600000,
    fill = NA,
    colour = "black",
    size = 0.7
  )


iqf_cow <- iqf_map |> cowplot::ggdraw() +
  draw_plot(
    {
      iqf_map +
        coord_sf(
          xlim = c(-46.700000, -46.600000),
          ylim = c(-23.600000, -23.500000),
          expand = FALSE
        ) +
        theme(legend.position = "none") +
        annotation_scale(location = "bl", line_width = 0.4)
    },
    x = 0.6,
    y = 0.1,
    width = 0.4,
    height = 0.4
  )

ggsave("exports/iqf.pdf", plot = iqf_cow, width = 5000, height = 5000, units = "px", dpi = 320)
```

\fig{Índice de Qualidade Financeira (IQF) no município de São Paulo (2010).}{fig:iqf}{exports/iqf.pdf}{Elaboração própria.}

\newpage


## *Análise espacial*

Utilizando o I de Moran, pode-se verificar se há autocorrelação espacial para os índices gerados na ACP, além disso, auxilia na escolha da matriz de pesos espaciais $W$ que será utilizada para realizar regressões. A @tbl-matrizes mostra uma comparação entre as matrizes Rainha de ordem 1, distância inversa de ordem 1 e 2, e, de 4, 5, 6 e 7 vizinhos mais próximos, para o IQF. A @tbl-matrizes-icf faz o mesmo para o ICF.

```{r, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
#| label: tbl-matrizes
#| tbl-cap: "Comparação entre as matrizes de pesos espaciais pelo I de Moran (IQF)."

# Criando matrizes de peso
library(spdep)
library(sp)

# Removendo regiões sem banco da análise
shape <- final2 |>
  dplyr::filter(
    !cd_ds %in% c("355030803", "355030852")
  ) |>
  sf::st_as_sf()

# Tramsformando em spatial object
spatial <- shape |> sf::as_Spatial()

rainha <- spdep::poly2nb(
  spatial,
  row.names = spatial$cd_ds,
  queen = TRUE
)

centroids <- sf::st_centroid(shape)
knn4 <- spdep::knn2nb(spdep::knearneigh(centroids, k=4), row.names = shape$cd_ds)
knn5 <- spdep::knn2nb(spdep::knearneigh(centroids, k=5), row.names = shape$cd_ds)
knn6 <- spdep::knn2nb(spdep::knearneigh(centroids, k=6), row.names = shape$cd_ds)
knn7 <- spdep::knn2nb(spdep::knearneigh(centroids, k=7), row.names = shape$cd_ds)


rainha_lista <- spdep::nb2listw(rainha, style="W", zero.policy = TRUE)
knn4_lista <- spdep::nb2listw(knn4, style="W", zero.policy = TRUE)
knn5_lista <- spdep::nb2listw(knn5, style="W", zero.policy = TRUE)
knn6_lista <- spdep::nb2listw(knn6, style="W", zero.policy = TRUE)
knn7_lista <- spdep::nb2listw(knn7, style="W", zero.policy = TRUE)


coords <- sp::coordinates(spatial)

mat.dist <- as.matrix(dist(coords, method = "euclidean"))
dist.inv <- 1/mat.dist

diag(dist.inv) <- 0

dist.inv.w <- spdep::mat2listw(dist.inv, style="W", row.names = spatial$cd_ds)

dist.inv2 <- 1/(mat.dist)^2
diag(dist.inv2) <- 0

dist.inv2.w <- spdep::mat2listw(dist.inv2, style = "W", row.names = spatial$cd_ds)

i_moran <- data.frame(
  Matriz = c("Rainha 1", "Distância Inversa 1", "Distância Inversa 2", "KNN 4", "KNN 5", "KNN 6", "KNN 7"),
  `I de Moran` = c(
    as.numeric(moran.test(spatial$comp2, rainha_lista)$estimate[1]),
    as.numeric(moran.test(spatial$comp2, dist.inv.w)$estimate[1]),
    as.numeric(moran.test(spatial$comp2, dist.inv2.w)$estimate[1]),
    as.numeric(moran.test(spatial$comp2, knn4_lista)$estimate[1]),
    as.numeric(moran.test(spatial$comp2, knn5_lista)$estimate[1]),
    as.numeric(moran.test(spatial$comp2, knn6_lista)$estimate[1]),
    as.numeric(moran.test(spatial$comp2, knn7_lista)$estimate[1])
  ),
  `p-value` = c(
    moran.test(spatial$comp2, rainha_lista)$p.value,
    moran.test(spatial$comp2, dist.inv.w)$p.value,
    moran.test(spatial$comp2, dist.inv2.w)$p.value,
    moran.test(spatial$comp2, knn4_lista)$p.value,
    moran.test(spatial$comp2, knn5_lista)$p.value,
    moran.test(spatial$comp2, knn6_lista)$p.value,
    moran.test(spatial$comp2, knn7_lista)$p.value
  )
)

i_moran |> stargazer::stargazer(
    header=FALSE,
    type='latex',
    summary = FALSE,
    rownames = FALSE,
    style = "aer",
    notes = "Fonte: Elaboração própria.",
    digits = 6
  )
```

```{r, echo=FALSE, results='asis'}
#| label: tbl-matrizes-icf
#| tbl-cap: "Comparação entre as matrizes de pesos espaciais pelo I de Moran (ICF)."


i_moran_icf <- data.frame(
  Matriz = c("Rainha 1", "Distância Inversa 1", "Distância Inversa 2", "KNN 4", "KNN 5", "KNN 6", "KNN 7"),
  `I de Moran` = c(
    as.numeric(moran.test(spatial$comp1, rainha_lista)$estimate[1]),
    as.numeric(moran.test(spatial$comp1, dist.inv.w)$estimate[1]),
    as.numeric(moran.test(spatial$comp1, dist.inv2.w)$estimate[1]),
    as.numeric(moran.test(spatial$comp1, knn4_lista)$estimate[1]),
    as.numeric(moran.test(spatial$comp1, knn5_lista)$estimate[1]),
    as.numeric(moran.test(spatial$comp1, knn6_lista)$estimate[1]),
    as.numeric(moran.test(spatial$comp1, knn7_lista)$estimate[1])
  ),
  `p-value` = c(
    moran.test(spatial$comp1, rainha_lista)$p.value,
    moran.test(spatial$comp1, dist.inv.w)$p.value,
    moran.test(spatial$comp1, dist.inv2.w)$p.value,
    moran.test(spatial$comp1, knn4_lista)$p.value,
    moran.test(spatial$comp1, knn5_lista)$p.value,
    moran.test(spatial$comp1, knn6_lista)$p.value,
    moran.test(spatial$comp1, knn7_lista)$p.value
  )
)

i_moran_icf |> stargazer::stargazer(
    header=FALSE,
    type='latex',
    summary = FALSE,
    rownames = FALSE,
    style = "aer",
    notes = "Fonte: Elaboração própria.",
    digits = 6
  )
```

As figuras \ref{fig:moran} e \ref{fig:moranicf} mostram a relação entre $y$ e $Wy$ (*lagged*), sendo $y =$ IQF ou ICF e $W =$ matriz de pesos de 5 (IQF) e 6 (ICF) vizinhos mais próximos. Ambos índices de Moran foram estatisticamente diferentes de zero, o que significa que há autocorrelação espacial para IQF e ICF, no entanto, a autocorrelação espacial do IQF é muito mais forte, indicando que o espaço importa mais na difusão de qualidade e diversidade de crédito, do que na questão de centralidade e volume de crédito. Como o bairro Sé é um *outlier* na centralidade do crédito, é possível que ele esteja mascarando algum aspecto das demais centralidades de crédito.

```{r, echo=FALSE,warning=FALSE}
#| label: fig-moran
#| fig-cap: "I de Moran para o IQF."

moran_i <- spdep::moran.test(shape$comp2, knn5_lista)
moran_local <- spdep::localmoran(shape$comp2, knn5_lista, alternative = "two.sided")

shape$ylag <- spdep::lag.listw(knn5_lista, shape$comp2)

shape$p_value <- moran_local[,5]

shape$quadrante <- ifelse(shape$p_value <= 0.05,
  ifelse(
    shape$comp2 > 0 & shape$ylag > 0, "High-High",
    ifelse(
      shape$comp2 < 0 & shape$ylag > 0, "Low-High",
      ifelse(
        shape$comp2 < 0 & shape$ylag < 0, "Low-Low", "High-Low"
      )
    )
  ), "Não significativo"
)

i_moran_iqf <- ggplot2::ggplot(shape, aes(x = comp2, y = ylag)) +
  ggplot2::geom_point(
    mapping = aes(colour = factor(quadrante)),
    size = 2
  ) +
  ggplot2::scale_colour_manual(
    name = "I de Moran Local (p <= 0.05)",
    values = c(
      "Não significativo" = "grey85",
      "High-High" = "#f8766d",
      "Low-Low" = "#00b4ef",
      "High-Low" = "#00bc59",
      "Low-High" = "#bf80ff"
    )
  ) +
  ggplot2::geom_abline(slope = as.numeric(moran_i$estimate)[1], color = "#7159c1", linewidth = 1) +
  ggplot2::geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
  ggplot2::geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  labs(title = paste("I de Moran: ", format(as.numeric(moran_i$estimate)[1], digits = 4)), x = "IQF", y = "lagged IQF") +
  ggplot2::coord_fixed(
    xlim = c(-10, 10),
    ylim = c(-10, 10)
  ) +
  ggplot2::theme_classic() +
  ggplot2::theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    title = element_text(size = 8, colour = "#7159c1"),
    plot.title = element_text(hjust = 0.5)
  )

ggsave("exports/imoraniqf.pdf", plot = i_moran_iqf, width = 40, height = 20, units = "cm", dpi = 320)
```

\fig{I de Moran para o IQF}{fig:moran}{exports/imoraniqf.pdf}{Elaboração própria.}

```{r, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
#| label: fig-moran-icf
#| fig-cap: "I de Moran para o ICF."

moran_i_icf <- spdep::moran.test(shape$comp1, knn6_lista)
moran_local_icf <- spdep::localmoran(shape$comp1, knn6_lista, alternative = "two.sided")

shape$ylag_icf <- lag.listw(knn7_lista, shape$comp1)

shape$p_value_icf <- moran_local_icf[,5]

shape$quadrante_icf <- ifelse(shape$p_value_icf <= 0.05,
  ifelse(
    shape$comp1 > 0 & shape$ylag_icf > 0, "High-High",
    ifelse(
      shape$comp1 < 0 & shape$ylag_icf > 0, "Low-High",
      ifelse(
        shape$comp1 < 0 & shape$ylag_icf < 0, "Low-Low", "High-Low"
      )
    )
  ), "Não significativo"
)


i_moran_icf <- ggplot2::ggplot(shape, aes(x = comp1, y = ylag_icf)) +
  ggplot2::geom_point(
    mapping = aes(colour = factor(quadrante_icf)),
    size = 2
  ) +
  ggplot2::scale_colour_manual(
    name = "I de Moran Local (p <= 0.05)",
    values = c(
      "Não significativo" = "grey85",
      "High-High" = "#f8766d",
      "Low-Low" = "#00b4ef",
      "High-Low" = "#00bc59",
      "Low-High" = "#bf80ff"
    )
  ) +
  ggplot2::geom_abline(slope = as.numeric(moran_i_icf$estimate)[1], color = "#7159c1", linewidth = 1) +
  ggplot2::geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
  ggplot2::geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  labs(title = paste("I de Moran: ", format(as.numeric(moran_i_icf$estimate)[1], digits = 4)), x = "ICF", y = "lagged ICF") +
  ggplot2::coord_fixed(
    xlim = c(-10, 10),
    ylim = c(-10, 10)
  ) +
  ggplot2::theme_classic() +
  ggplot2::theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    title = element_text(size = 8, colour = "#7159c1"),
    plot.title = element_text(hjust = 0.5)
  )

ggsave("exports/imoranicf.pdf", plot = i_moran_icf, width = 40, height = 20, units = "cm", dpi = 320)
```

\fig{I de Moran para o ICF}{fig:moranicf}{exports/imoranicf.pdf}{Elaboração própria.}

As figuras \ref{fig:moranlocal} e \ref{fig:moranlocalicf} mostram a dispersão geográfica dos *clusters* LISA (*Local Indicators of Spatial Association*), baseado no I de Moran Local. Esses *clusters* mostram se determinada região tem padrão semelhante aos seus vizinhos, classificados em quatro tipos: High-High (Pontos com valores altos cercados por outros pontos com valores altos); Low-Low (Pontos com valores baixos cercados por outros pontos com valores baixos); High-Low (Pontos com valores altos cercados por outros pontos com valores baixos); e Low-High (Pontos com valores baixos cercados por outros pontos com valores altos). Nas figuras foram destacadas apenas as regiões significativas ($p \leq 0.05$) no teste do I de Moran Local.

Pode-se observar uma formação de cluster *Low-Low* na Zona Leste (extremo leste) de São Paulo para o IQF, indicando que se trata de uma periferia em termos de qualidade de serviço financeiro, aglomerando distritos que compartilham dos mesmos baixos índices. Ainda em relação ao IQF, observa-se um cluster *High-High* contendo alguns dos distritos mais ricos da cidade de São Paulo: Campo Belo e Moema. Indicando que se trata de um forte centro financeiro, rodeado de distritos com qualidade financeira similar.

Sobre o ICF, vemos a formação de um grupo bem no centro da cidade, composto exclusivamente por *outliers* em termos de centralidade financeira, e que formam um espécie de anel em torno do centro histórico (Sé). Os clusters *Low-High* nesse anel indicam que há distritos com baixa concentração de crédito, mas que estão cercados por distritos concentradores de crédito, que formam clusters *High-High*.

```{r, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

moranlocal_map <- ggplot2::ggplot() +
  ggplot2::geom_sf(data = shape, mapping = aes(fill = quadrante), lwd = 0, colour = NA) +
  ggplot2::scale_fill_manual(
    name = "IQF",
    values = c(
      "Não significativo" = "grey85",
      "High-High" = "#f8766d",
      "Low-Low" = "#00b4ef",
      "High-Low" = "#00bc59",
      "Low-High" = "#bf80ff"
    )
  ) +
  ggrepel::geom_text_repel(
    data = subset(shape, shape$quadrante %in% c("High-High", "High-Low", "Low-Low", "Low-High")),
    aes(label = name_district, geometry=geometry),
    stat = "sf_coordinates",
    min.segment.length = 0,
    box.padding = 1,
    size = 5
  ) +
  ggplot2::geom_sf(
    data = subset(final2, !final2$cd_ds %in% shape$cd_ds),
    lwd = 0,
    colour = NA
  ) +
  theme_void() +
  theme(
    text = element_text(face = "plain"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 14, face = "plain"),
    legend.position = "left",
    legend.box.spacing = unit(0.5, "cm"),
    legend.spacing.y = unit(1, "cm")
  ) +
  annotation_scale(location = "bl", line_width = 0.4) +
  annotation_north_arrow(
    location = "br",
    style = north_arrow_fancy_orienteering(),
    height = unit(1, "cm"),
    width = unit(1, "cm")
  )


moranlocal_map <-
  moranlocal_map + geom_rect(
    xmin = -46.630000,
    ymin = -23.550000,
    xmax = -46.730000,
    ymax = -23.650000,
    fill = NA,
    colour = "black",
    size = 0.7
  )


moranlocal_cow <- moranlocal_map |> cowplot::ggdraw() +
  draw_plot(
    {
      moranlocal_map +
        coord_sf(
          xlim = c(-46.730000, -46.630000),
          ylim = c(-23.650000, -23.550000),
          expand = FALSE
        ) +
        theme(legend.position = "none") +
        annotation_scale(location = "bl", line_width = 0.4)
    },
    x = 0.6,
    y = 0.1,
    width = 0.4,
    height = 0.4
  )

ggsave("exports/moranlocal.pdf", plot = moranlocal_map, width = 5000, height = 5000, units = "px", dpi = 320)
```

\fig{Clusters LISA (I de Moran Local) - IQF}{fig:moranlocal}{exports/moranlocal.pdf}{Elaboração própria.}

```{r, echo=FALSE, warning=FALSE}

moranlocalicf_map <- ggplot2::ggplot() +
  ggplot2::geom_sf(data = shape, mapping = aes(fill = quadrante_icf), lwd = 0, colour = NA) +
  ggplot2::scale_fill_manual(
    name = "ICF",
    values = c(
      "Não significativo" = "grey85",
      "High-High" = "#f8766d",
      "Low-Low" = "#00b4ef",
      "High-Low" = "#00bc59",
      "Low-High" = "#bf80ff"
    )
  ) +
  ggrepel::geom_text_repel(
    data = subset(shape, shape$quadrante_icf %in% c("High-High", "High-Low", "Low-Low", "Low-High")),
    aes(label = name_district, geometry=geometry),
    stat = "sf_coordinates",
    min.segment.length = 0,
    box.padding = 1,
    size = 5
  ) +
  ggplot2::geom_sf(
    data = subset(final2, !final2$cd_ds %in% shape$cd_ds),
    lwd = 0,
    colour = NA
  ) +
  theme_void() +
  theme(
    text = element_text(face = "plain"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 14, face = "plain"),
    legend.position = "left",
    legend.box.spacing = unit(0.5, "cm"),
    legend.spacing.y = unit(1, "cm")
  ) +
  annotation_scale(location = "bl", line_width = 0.4) +
  annotation_north_arrow(
    location = "br",
    style = north_arrow_fancy_orienteering(),
    height = unit(1, "cm"),
    width = unit(1, "cm")
  )


moranlocalicf_map <-
  moranlocalicf_map + geom_rect(
    xmin = -46.630000,
    ymin = -23.550000,
    xmax = -46.730000,
    ymax = -23.650000,
    fill = NA,
    colour = "black",
    size = 0.7
  )


moranlocalicf_cow <- moranlocalicf_map |> cowplot::ggdraw() +
  draw_plot(
    {
      moranlocalicf_map +
        coord_sf(
          xlim = c(-46.730000, -46.630000),
          ylim = c(-23.650000, -23.550000),
          expand = FALSE
        ) +
        theme(legend.position = "none") +
        annotation_scale(location = "bl", line_width = 0.4)
    },
    x = 0.6,
    y = 0.1,
    width = 0.4,
    height = 0.4
  )

ggsave("exports/moranlocalicf.pdf", plot = moranlocalicf_map, width = 5000, height = 5000, units = "px", dpi = 320)
```

\fig{Clusters LISA (I de Moran Local) - ICF}{fig:moranlocalicf}{exports/moranlocalicf.pdf}{Elaboração própria.}

Agora, podemos estimar alguns modelos de regressão e verificar o impacto dos índices de qualidade e centralidade financeira na renda *per capita* dos distritos.

Começando pelo MQO sem efeitos espaciais, expresso por:

```{=tex}
\begin{equation}
RPC = \beta_{1} ICF + \beta_{2} IQF + \varepsilon
\end{equation}
```


```{r, echo=FALSE, warning=FALSE, results='asis'}
#| label: tbl-mqo
#| tbl-cap: "Estatísticas do MQO."

spatial$ICF <- spatial$comp1
spatial$IQF <- spatial$comp2

equacaoabsoluta = rpc ~ 1 + ICF + IQF + ag_ncnd + banheir + esgoto + enrg_lt

options(scipen=11)

reg1_mqo <- lm(equacaoabsoluta, data=spatial)

stargazer::stargazer(
  reg1_mqo,
  header=FALSE,
  type='latex',
  style = "aer",
  notes = "Fonte: Elaboração própria."
)
```

Para os modelos espaciais, precisamos escolher uma matriz de peso que melhor capte a autocorrelação residual, a @tbl-moranresiduos compara as matrizes de peso pelo I de Moran dos resíduos da regressão.

```{r, echo=FALSE, results='asis'}
#| label: tbl-moranresiduos
#| tbl-cap: "I de Moran dos resíduos do MQO para diferentes matrizes de peso."

residuals_imoran <- data.frame(
  Matriz = c("Rainha 1", "Distância Inversa 1", "Distância Inversa 2", "KNN 4", "KNN 5", "KNN 6", "KNN 7"),
  `I de Moran (Resíduos)` = c(
    as.numeric(lm.morantest(reg1_mqo, listw = rainha_lista)$estimate[1]),
    as.numeric(lm.morantest(reg1_mqo, listw = dist.inv.w)$estimate[1]),
    as.numeric(lm.morantest(reg1_mqo, listw = dist.inv2.w)$estimate[1]),
    as.numeric(lm.morantest(reg1_mqo, listw = knn4_lista)$estimate[1]),
    as.numeric(lm.morantest(reg1_mqo, listw = knn5_lista)$estimate[1]),
    as.numeric(lm.morantest(reg1_mqo, listw = knn6_lista)$estimate[1]),
    as.numeric(lm.morantest(reg1_mqo, listw = knn7_lista)$estimate[1])
  ),
  `p-value` = c(
    as.numeric(lm.morantest(reg1_mqo, listw = rainha_lista)$p.value),
    as.numeric(lm.morantest(reg1_mqo, listw = dist.inv.w)$p.value),
    as.numeric(lm.morantest(reg1_mqo, listw = dist.inv2.w)$p.value),
    as.numeric(lm.morantest(reg1_mqo, listw = knn4_lista)$p.value),
    as.numeric(lm.morantest(reg1_mqo, listw = knn5_lista)$p.value),
    as.numeric(lm.morantest(reg1_mqo, listw = knn6_lista)$p.value),
    as.numeric(lm.morantest(reg1_mqo, listw = knn7_lista)$p.value)
  )
)

residuals_imoran %>% stargazer::stargazer(
  header=FALSE,
  type='latex',
  summary = FALSE,
  rownames = FALSE,
  style = "aer",
  notes = "Fonte: Elaboração própria.",
  digits = 6
)
```

Escolhida a matriz de 4 vizinhos mais próximos, podemos prosseguir para os testes LM (Lagrange Multiplier) e LM Robusto, que nos ajudam a escolher entre o modelo de erros, de *lag* espacial e o modelo SARMA (erros e *lag*):

```{r echo=FALSE, results='asis'}
#| label: tbl-lmtestes
#| tbl-cap: "Resultado dos testes de LM e LM Robusto."

testes <- lm.LMtests(reg1_mqo,listw=knn4_lista, test=c("LMerr", "LMlag", "RLMerr", "RLMlag", "SARMA"))

print_testes <- data.frame(
  "Test" = names(testes),
  "Statistic" = as.numeric(sapply(testes, function(x) x$statistic)),
  "p-value" = as.numeric(sapply(testes, function(x) x$p.value))
)

stargazer::stargazer(
  data = print_testes,
  header=FALSE,
  type='latex',
  summary = FALSE,
  rownames = FALSE,
  style = "aer",
  notes = "Fonte: Elaboração própria.",
  digits = 6
)
```

Pela estatística dos testes, devemos escolher o modelo de *lag* espacial, o que condiz com o referencial teórico e com as explicitações na metodologia. Além disso, devemos comparar os modelos SLX e SDM com a matriz de 4 vizinhos mais próximos com o teste LR (Likelihood Ratio):

```{r, echo=FALSE, results='asis', warning=FALSE}
#| label: tbl-lrteste
#| tbl-cap: "Resultado do teste LR entre os modelos SLX e SLM."

reg_slx <- spatialreg::lmSLX(formula = "rpc ~ 1 + ICF + IQF + ag_ncnd + banheir + esgoto + enrg_lt", data=spatial, listw=knn4_lista)

reg_sdm <- spatialreg::lagsarlm(equacaoabsoluta, data=spatial, listw=knn4_lista, type="mixed")

lr_test <- spatialreg::LR.Sarlm(reg_slx, reg_sdm)

lr_test_print <- data.frame(
  `Model` = c(
    "SLX",
    "SDM"
  ),
  `Log likelihood` = c(
    as.numeric(lr_test$estimate[1]),
    as.numeric(lr_test$estimate[2])
  )
)

lr_test_print |>
  stargazer::stargazer(type="latex", header=FALSE, summary = FALSE, notes = c(paste("LR: ", round(lr_test$statistic, 3)), paste("p.value: ", lr_test$p.value)))
```

Como o teste LR disse que os modelos são estatísticamente diferentes e o que tem melhor ajuste é o SLX, opta-se por escolhê-lo neste trabalho. A @tbl-slx mostra seu resultado: 

```{r echo=FALSE, results='asis'}
#| label: tbl-slx
#| tbl-cap: Resultados do modelo SLX.

reg_slx %>%
  stargazer::stargazer(
    header=FALSE,
    type='latex',
    summary = FALSE,
    rownames = FALSE,
    style = "aer",
    notes = "Fonte: Elaboração própria.",
    dep.var.labels = "RPC",
    digits = 6
  )
```

\newpage

# REFERÊNCIAS
::: {#refs}
:::